# é”™è¯¯å¤„ç†ä¸æ¢å¤

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**  
- [session_manager.js](file://background/managers/session_manager.js)
- [auth_manager.js](file://background/managers/auth_manager.js)
- [gemini_api.js](file://services/gemini_api.js)
- [auth.js](file://services/auth.js)
- [parser.js](file://services/parser.js)
- [prompt_handler.js](file://background/handlers/session/prompt_handler.js)
- [stream.js](file://content/toolbar/stream.js)
- [message.js](file://sandbox/render/message.js)
</cite>

## ç›®å½•
1. [å¼•è¨€](#å¼•è¨€)
2. [é”™è¯¯å¤„ç†æ¶æ„æ¦‚è¿°](#é”™è¯¯å¤„ç†æ¶æ„æ¦‚è¿°)
3. [å†…å±‚é”™è¯¯æ•è·ä¸è´¦æˆ·è½®æ¢æœºåˆ¶](#å†…å±‚é”™è¯¯æ•è·ä¸è´¦æˆ·è½®æ¢æœºåˆ¶)
4. [å¤–å±‚é”™è¯¯è½¬æ¢ä¸ç”¨æˆ·å‹å¥½æ¶ˆæ¯](#å¤–å±‚é”™è¯¯è½¬æ¢ä¸ç”¨æˆ·å‹å¥½æ¶ˆæ¯)
5. AbortError ç‰¹æ®Šå¤„ç†
6. [é”™è¯¯ç±»å‹ä¸UIå‘ˆç°ç­–ç•¥](#é”™è¯¯ç±»å‹ä¸uiå‘ˆç°ç­–ç•¥)
7. [chrome.storage.local æ“ä½œçš„å®‰å…¨æ€§ä¸å¿…è¦æ€§](#chromestoragelocal-æ“ä½œçš„å®‰å…¨æ€§ä¸å¿…è¦æ€§)
8. [é”™è¯¯æ¢å¤æµç¨‹çŠ¶æ€è½¬æ¢å›¾](#é”™è¯¯æ¢å¤æµç¨‹çŠ¶æ€è½¬æ¢å›¾)

## å¼•è¨€
æœ¬é¡¹ç›®é€šè¿‡å¤šå±‚çº§çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿åœ¨ä¸ Gemini æœåŠ¡äº¤äº’è¿‡ç¨‹ä¸­èƒ½å¤Ÿæœ‰æ•ˆåº”å¯¹è®¤è¯å¤±æ•ˆã€é¢‘ç‡é™åˆ¶ã€ç½‘ç»œå¼‚å¸¸ç­‰å„ç±»é”™è¯¯ã€‚ç³»ç»Ÿé‡‡ç”¨å†…å±‚ä¸å¤–å±‚åŒé‡ `try-catch` ç»“æ„ï¼Œåˆ†åˆ«è´Ÿè´£åº•å±‚é”™è¯¯çš„è‡ªåŠ¨æ¢å¤ä¸ä¸Šå±‚é”™è¯¯çš„ç”¨æˆ·å‹å¥½è½¬æ¢ã€‚æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ä¼šè¯ç®¡ç†å™¨ï¼ˆ`GeminiSessionManager`ï¼‰ã€è®¤è¯ç®¡ç†å™¨ï¼ˆ`AuthManager`ï¼‰ä»¥åŠ Gemini API æœåŠ¡æ¨¡å—ï¼Œå®ƒä»¬ååŒå·¥ä½œä»¥å®ç°é«˜å¯ç”¨æ€§å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–ã€‚

## é”™è¯¯å¤„ç†æ¶æ„æ¦‚è¿°
ç³»ç»Ÿçš„é”™è¯¯å¤„ç†æœºåˆ¶é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œä¸»è¦ç”± `GeminiSessionManager` çš„ `handleSendPrompt` æ–¹æ³•å®ç°ã€‚è¯¥æ–¹æ³•åŒ…å«ä¸¤ä¸ªåµŒå¥—çš„ `try-catch` å—ï¼š

- **å†…å±‚ `try-catch`**ï¼šä½äºé‡è¯•å¾ªç¯å†…éƒ¨ï¼Œè´Ÿè´£è¯†åˆ« 401/403 ç­‰è®¤è¯é”™è¯¯ï¼Œå¹¶è§¦å‘å¤šè´¦æˆ·è½®æ¢ï¼ˆ`rotateAccount`ï¼‰å’Œä¸Šä¸‹æ–‡å¼ºåˆ¶åˆ·æ–°ï¼ˆ`forceContextRefresh`ï¼‰ã€‚
- **å¤–å±‚ `try-catch`**ï¼šå¤„ç†å†…å±‚æŠ›å‡ºçš„é”™è¯¯ï¼Œå°†å…¶è½¬æ¢ä¸ºæœ¬åœ°åŒ–çš„ç”¨æˆ·å‹å¥½æ¶ˆæ¯ï¼Œå¹¶é€šè¿‡æ¶ˆæ¯ç³»ç»Ÿå‘é€è‡³å‰ç«¯ UI è¿›è¡Œå±•ç¤ºã€‚

è¯¥æ¶æ„ç¡®ä¿äº†åœ¨å‘ç”Ÿå¯æ¢å¤é”™è¯¯æ—¶èƒ½å¤Ÿè‡ªåŠ¨é‡è¯•ï¼Œè€Œåœ¨å‘ç”Ÿä¸å¯æ¢å¤é”™è¯¯æ—¶èƒ½å¤Ÿå‘ç”¨æˆ·æä¾›æ¸…æ™°çš„æŒ‡å¯¼ã€‚

**Section sources**
- [session_manager.js](file://background/managers/session_manager.js#L21-L202)

## å†…å±‚é”™è¯¯æ•è·ä¸è´¦æˆ·è½®æ¢æœºåˆ¶
å½“å†…å±‚ `catch` å—æ•è·åˆ°é”™è¯¯æ—¶ï¼Œä¼šé€šè¿‡ `err.message` ä¸­çš„å…³é”®å­—ï¼ˆå¦‚ "æœªç™»å½•"ã€"Not logged in"ã€"401"ã€"403"ï¼‰åˆ¤æ–­æ˜¯å¦ä¸ºè®¤è¯é”™è¯¯ã€‚è‹¥ä¸ºè®¤è¯é”™è¯¯ä¸”å½“å‰é…ç½®äº†å¤šä¸ªè´¦æˆ·ï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ¢å¤æ“ä½œï¼š

1. **è´¦æˆ·è½®æ¢**ï¼šè°ƒç”¨ `AuthManager` çš„ `rotateAccount()` æ–¹æ³•ï¼Œå°†å½“å‰è´¦æˆ·æŒ‡é’ˆåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç´¢å¼•ï¼Œå¹¶æ›´æ–° `chrome.storage.local` ä¸­çš„ `geminiAccountPointer`ã€‚
2. **ä¸Šä¸‹æ–‡åˆ·æ–°**ï¼šè°ƒç”¨ `forceContextRefresh()` æ–¹æ³•ï¼Œå°†å†…å­˜ä¸­çš„ `currentContext` ç½®ä¸º `null`ï¼Œå¼ºåˆ¶ä¸‹æ¬¡è¯·æ±‚æ—¶é‡æ–°è·å–è®¤è¯ä»¤ç‰Œã€‚

æ­¤æœºåˆ¶é€šè¿‡ `while` å¾ªç¯å®ç°è‡ªåŠ¨é‡è¯•ï¼Œæœ€å¤šå°è¯•æ¬¡æ•°ç”± `auth.accountIndices.length` å†³å®šã€‚è‹¥è½®æ¢è´¦æˆ·åä»æ— æ³•é€šè¿‡è®¤è¯ï¼Œåˆ™å°†é”™è¯¯æŠ›å‡ºè‡³å¤–å±‚ `catch` å—è¿›è¡Œæœ€ç»ˆå¤„ç†ã€‚

```mermaid
flowchart TD
A[å‘é€è¯·æ±‚] --> B{è®¤è¯é”™è¯¯?}
B --> |æ˜¯| C[è½®æ¢è´¦æˆ· rotateAccount]
C --> D[å¼ºåˆ¶åˆ·æ–°ä¸Šä¸‹æ–‡ forceContextRefresh]
D --> E[é‡è¯•è¯·æ±‚]
B --> |å¦| F[æŠ›å‡ºé”™è¯¯]
E --> G{æˆåŠŸ?}
G --> |æ˜¯| H[è¿”å›æˆåŠŸ]
G --> |å¦| I[æŠ›å‡ºé”™è¯¯]
```

**Diagram sources**
- [session_manager.js](file://background/managers/session_manager.js#L129-L146)
- [auth_manager.js](file://background/managers/auth_manager.js#L53-L69)

**Section sources**
- [session_manager.js](file://background/managers/session_manager.js#L129-L146)
- [auth_manager.js](file://background/managers/auth_manager.js#L53-L69)

## å¤–å±‚é”™è¯¯è½¬æ¢ä¸ç”¨æˆ·å‹å¥½æ¶ˆæ¯
å¤–å±‚ `catch` å—è´Ÿè´£å°†åº•å±‚é”™è¯¯è½¬æ¢ä¸ºç”¨æˆ·å¯ç†è§£çš„æœ¬åœ°åŒ–æ¶ˆæ¯ã€‚è½¬æ¢é€»è¾‘åŸºäº `error.message` çš„å†…å®¹ï¼Œå¹¶æ ¹æ®å½“å‰æµè§ˆå™¨çš„ UI è¯­è¨€ï¼ˆé€šè¿‡ `chrome.i18n.getUILanguage()` è·å–ï¼‰é€‰æ‹©ä¸­æ–‡æˆ–è‹±æ–‡æç¤ºã€‚

æ”¯æŒçš„é”™è¯¯ç±»å‹åŠå¯¹åº”çš„ UI æ¶ˆæ¯å¦‚ä¸‹ï¼š

| é”™è¯¯ç±»å‹ | ä¸­æ–‡æ¶ˆæ¯ | è‹±æ–‡æ¶ˆæ¯ |
|---------|--------|--------|
| ç™»å½•å¤±æ•ˆ | ğŸ”‘ è´¦å· (Index: X) æœªç™»å½•æˆ–ä¼šè¯å·²è¿‡æœŸã€‚<br><a href="#" class="gemini-link" data-url="https://gemini.google.com/u/X/">ğŸ‘‰ ç‚¹å‡»å‰å¾€ Gemini ç™»å½•</a> | ğŸ”‘ Account (Index: X) not logged in.<br><a href="#" class="gemini-link" data-url="https://gemini.google.com/u/X/">ğŸ‘‰ Click to open Gemini login</a> |
| é¢‘ç‡é™åˆ¶ | â³ è¯·æ±‚è¿‡äºé¢‘ç¹ï¼ŒGemini æš‚æ—¶é™åˆ¶äº†è®¿é—®ã€‚è¯·ç­‰å¾…å‡ åˆ†é’Ÿåå†è¯•ã€‚ | â³ Too many requests. Gemini has temporarily limited access. Please wait a few minutes. |
| ç©ºå“åº” | ğŸ”Œ æœåŠ¡å™¨æ— å“åº”ã€‚<br><a href="#" class="gemini-link" data-url="https://gemini.google.com/">ğŸ‘‰ ç‚¹å‡»å‰å¾€ Gemini åˆ·æ–°</a> | ğŸ”Œ No response from server.<br><a href="#" class="gemini-link" data-url="https://gemini.google.com/">ğŸ‘‰ Click to refresh Gemini</a> |
| è§£æå¤±è´¥ | âš ï¸ å“åº”è§£æå¤±è´¥ã€‚<br><a href="#" class="gemini-link" data-url="https://gemini.google.com/">ğŸ‘‰ ç‚¹å‡»å‰å¾€ Gemini åˆ·æ–°åé‡è¯•</a> | âš ï¸ Failed to parse response.<br><a href="#" class="gemini-link" data-url="https://gemini.google.com/">ğŸ‘‰ Click to refresh Gemini and retry</a> |

è¿™äº›æ¶ˆæ¯é€šè¿‡ `chrome.runtime.sendMessage` å‘é€è‡³å‰ç«¯ï¼Œç”± `GeminiStreamHandler` å¤„ç†å¹¶è°ƒç”¨ `ui.showError()` æ–¹æ³•å±•ç¤ºã€‚

**Section sources**
- [session_manager.js](file://background/managers/session_manager.js#L149-L198)

## AbortError ç‰¹æ®Šå¤„ç†
å½“ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆè¯·æ±‚æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºå¹¶è§¦å‘ä¸€ä¸ª `AbortController`ï¼Œä»è€ŒæŠ›å‡º `AbortError`ã€‚è¯¥é”™è¯¯åœ¨ `handleSendPrompt` çš„å¤–å±‚ `catch` å—ä¸­è¢«ç‰¹æ®Šå¤„ç†ï¼šç›´æ¥è¿”å› `null`ï¼Œè¡¨ç¤ºè¯·æ±‚å·²è¢«å–æ¶ˆã€‚å‰ç«¯ UI åœ¨æ¥æ”¶åˆ° `null` å“åº”æ—¶ï¼Œä¸ä¼šæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œè€Œæ˜¯ä¿æŒå½“å‰çŠ¶æ€æˆ–æ¸…é™¤åŠ è½½æŒ‡ç¤ºå™¨ã€‚

```mermaid
sequenceDiagram
participant UI as å‰ç«¯UI
participant SM as SessionManager
participant API as Gemini API
UI->>SM : å‘é€è¯·æ±‚ (SEND_PROMPT)
SM->>API : å‘èµ·fetchè¯·æ±‚ (å¸¦signal)
UI->>SM : å–æ¶ˆè¯·æ±‚ (CANCEL_PROMPT)
SM->>API : signal.abort() -> AbortError
API-->>SM : æŠ›å‡ºAbortError
SM-->>UI : è¿”å›null
UI->>UI : ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œä¿æŒçŠ¶æ€
```

**Diagram sources**
- [session_manager.js](file://background/managers/session_manager.js#L150-L152)
- [session.js](file://background/handlers/session.js#L38-L41)

**Section sources**
- [session_manager.js](file://background/managers/session_manager.js#L150-L152)

## é”™è¯¯ç±»å‹ä¸UIå‘ˆç°ç­–ç•¥
ä¸åŒç±»å‹çš„é”™è¯¯åœ¨ UI ä¸Šæœ‰ä¸åŒçš„å‘ˆç°ç­–ç•¥ï¼Œä¸»è¦é€šè¿‡ `GeminiStreamHandler` å’Œ `appendMessage` å‡½æ•°å®ç°ã€‚

- **è®¤è¯é”™è¯¯**ï¼šæ˜¾ç¤ºåŒ…å«ç™»å½•é“¾æ¥çš„å¯Œæ–‡æœ¬æ¶ˆæ¯ï¼Œç”¨æˆ·å¯ç›´æ¥ç‚¹å‡»é“¾æ¥è·³è½¬è‡³ Gemini ç™»å½•é¡µé¢ã€‚
- **é¢‘ç‡é™åˆ¶**ï¼šæ˜¾ç¤ºç­‰å¾…æç¤ºï¼Œå»ºè®®ç”¨æˆ·ç¨åå†è¯•ã€‚
- **ç©ºå“åº”ä¸è§£æå¤±è´¥**ï¼šæ˜¾ç¤ºåˆ·æ–°é“¾æ¥ï¼Œå¼•å¯¼ç”¨æˆ·åˆ·æ–° Gemini é¡µé¢ä»¥æ¢å¤ä¼šè¯ã€‚
- **å·¥å…·æ‰§è¡Œé”™è¯¯**ï¼šåœ¨å“åº”æµä¸­è¿½åŠ é”™è¯¯ä¿¡æ¯ï¼Œæ ¼å¼ä¸º `> âŒ Tool Error: ${e.message}`ï¼Œä¸å½±å“ä¸»å“åº”å†…å®¹ã€‚

å‰ç«¯é€šè¿‡ç›‘å¬ `GEMINI_STREAM_UPDATE` å’Œ `GEMINI_STREAM_DONE` æ¶ˆæ¯ï¼Œå®æ—¶æ›´æ–° UI çŠ¶æ€ã€‚é”™è¯¯æ¶ˆæ¯é€šè¿‡ `ui.showError()` æ–¹æ³•å±•ç¤ºï¼Œç¡®ä¿ç”¨æˆ·èƒ½å¤ŸåŠæ—¶è·çŸ¥æ“ä½œç»“æœã€‚

**Section sources**
- [stream.js](file://content/toolbar/stream.js#L16-L43)
- [message.js](file://sandbox/render/message.js#L39-L57)

## chrome.storage.local æ“ä½œçš„å®‰å…¨æ€§ä¸å¿…è¦æ€§
åœ¨è®¤è¯é”™è¯¯å¤„ç†æµç¨‹ä¸­ï¼Œç³»ç»Ÿä¼šç›´æ¥æ“ä½œ `chrome.storage.local` æ‰§è¡Œ `remove(['geminiContext'])`ã€‚è¿™ä¸€æ“ä½œå…·æœ‰ä»¥ä¸‹å®‰å…¨æ€§å’Œå¿…è¦æ€§ï¼š

- **å¿…è¦æ€§**ï¼šæ¸…é™¤æœ¬åœ°å­˜å‚¨çš„æ— æ•ˆä¼šè¯ä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢åç»­è¯·æ±‚é‡å¤ä½¿ç”¨å·²è¿‡æœŸçš„ä»¤ç‰Œï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿä»å¹²å‡€çŠ¶æ€é‡æ–°åˆå§‹åŒ–ã€‚
- **å®‰å…¨æ€§**ï¼š`chrome.storage.local` æ˜¯ Chrome æ‰©å±•çš„å®‰å…¨å­˜å‚¨æœºåˆ¶ï¼Œæ•°æ®ä»…é™æœ¬æ‰©å±•è®¿é—®ï¼Œä¸ä¼šè¢«ç¬¬ä¸‰æ–¹ç½‘ç«™è¯»å–ã€‚`remove` æ“ä½œä»…å½±å“ç‰¹å®šé”®å€¼ï¼Œä¸ä¼šæ¸…é™¤ç”¨æˆ·å…¶ä»–æ•°æ®ã€‚

æ­¤å¤–ï¼Œ`AuthManager` åœ¨åˆå§‹åŒ–æ—¶ä¼šä» `chrome.storage.local` æ¢å¤ `geminiContext`ã€`geminiModel` ç­‰çŠ¶æ€ï¼Œç¡®ä¿è·¨ä¼šè¯çš„è¿ç»­æ€§ã€‚

**Section sources**
- [session_manager.js](file://background/managers/session_manager.js#L162)
- [auth_manager.js](file://background/managers/auth_manager.js#L18-L47)

## é”™è¯¯æ¢å¤æµç¨‹çŠ¶æ€è½¬æ¢å›¾
ä»¥ä¸‹çŠ¶æ€å›¾æè¿°äº†ä»è¯·æ±‚å‘é€åˆ°é”™è¯¯æ¢å¤çš„å®Œæ•´æµç¨‹ã€‚

```mermaid
stateDiagram-v2
[*] --> Idle
Idle --> Sending : å‘é€è¯·æ±‚
Sending --> AuthError : 401/403é”™è¯¯
Sending --> RateLimit : 429é”™è¯¯
Sending --> EmptyResponse : ç©ºå“åº”
Sending --> ParseError : è§£æå¤±è´¥
Sending --> Success : æˆåŠŸå“åº”
AuthError --> RotatingAccount : rotateAccount()
RotatingAccount --> RefreshingContext : forceContextRefresh()
RefreshingContext --> Sending : é‡è¯•è¯·æ±‚
AuthError --> FinalError : é‡è¯•å¤±è´¥
RateLimit --> FinalError
EmptyResponse --> FinalError
ParseError --> FinalError
FinalError --> ShowingError : æ˜¾ç¤ºç”¨æˆ·å‹å¥½æ¶ˆæ¯
ShowingError --> Idle : ç”¨æˆ·æ“ä½œåæ¢å¤
Success --> Idle : æ­£å¸¸ç»“æŸ
```

**Diagram sources**
- [session_manager.js](file://background/managers/session_manager.js#L21-L202)
- [gemini_api.js](file://services/gemini_api.js#L154-L219)
# 工具发现机制

<cite>
**本文档引用的文件**
- [mcp_manager.js](file://background/managers/mcp_manager.js)
- [messages.js](file://background/messages.js)
- [mcp_controller.js](file://sandbox/controllers/mcp_controller.js)
- [message_handler.js](file://sandbox/controllers/message_handler.js)
- [background_index.js](file://background/index.js)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

本文档深入解析MCP（Model Context Protocol）工具发现机制，重点分析`refreshTools`和`refreshToolsHttp`方法的实现。该机制负责自动检测和连接MCP服务器，支持多种通信模式（SSE、streamable_http、http），并能够处理不同格式的工具列表响应。

系统通过`connectServer`方法初始化连接，根据服务器配置的`type`字段自动选择通信模式。当服务器返回`application/json`内容类型时，系统会自动降级到HTTP模式，确保兼容性。

## 项目结构

MCP工具发现机制分布在以下关键文件中：

```mermaid
graph TB
subgraph "后台进程"
BM[background/index.js<br/>后台入口]
MM[MCPManager<br/>工具发现核心]
MSG[messages.js<br/>消息处理]
end
subgraph "沙盒环境"
MC[MCPController<br/>UI控制]
MH[message_handler.js<br/>消息处理]
end
BM --> MM
MSG --> MM
MC --> MSG
MH --> MM
```

**图表来源**
- [background_index.js](file://background/index.js#L1-L30)
- [mcp_manager.js](file://background/managers/mcp_manager.js#L1-L530)
- [messages.js](file://background/messages.js#L1-L82)
- [mcp_controller.js](file://sandbox/controllers/mcp_controller.js#L1-L221)
- [message_handler.js](file://sandbox/controllers/message_handler.js#L75-L113)

**章节来源**
- [background_index.js](file://background/index.js#L1-L30)
- [mcp_manager.js](file://background/managers/mcp_manager.js#L1-L530)

## 核心组件

### MCPManager类

MCPManager是工具发现机制的核心，负责：
- 服务器连接管理
- 工具列表刷新
- 多种通信模式支持
- 调试信息收集

主要方法包括：
- `connectServer()`: 初始化服务器连接
- `refreshTools()`: 刷新工具列表
- `refreshToolsHttp()`: HTTP模式下的工具刷新
- `isHttpMode()`: 检查服务器是否处于HTTP模式
- `getDebugInfo()`: 获取调试信息

**章节来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L2-L530)

### 通信模式检测

系统支持三种通信模式：
1. **SSE模式** (`type: 'sse'`): 标准MCP协议，使用Server-Sent Events
2. **HTTP模式** (`type: 'http'`): 直接HTTP POST请求
3. **流式HTTP模式** (`type: 'streamable_http'`): 支持流式响应的HTTP模式

**章节来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L75-L96)

## 架构概览

```mermaid
sequenceDiagram
participant BG as 后台进程
participant MM as MCPManager
participant ES as EventSource
participant HTTP as HTTP客户端
participant SV as MCP服务器
BG->>MM : init()
MM->>MM : loadConfig()
loop 遍历服务器配置
MM->>MM : connectServer(id)
alt SSE模式
MM->>ES : 创建SSE连接
ES->>SV : GET /sse-endpoint
SV-->>ES : SSE流或JSON响应
alt 返回JSON
ES->>MM : 自动降级到HTTP模式
MM->>HTTP : POST /tools/list
else 返回SSE流
ES->>MM : endpoint事件
MM->>HTTP : POST /post-url
end
else HTTP模式
MM->>HTTP : POST /tools/list
end
end
```

**图表来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L71-L150)
- [mcp_manager.js](file://background/managers/mcp_manager.js#L152-L213)

## 详细组件分析

### connectServer方法分析

connectServer方法是工具发现机制的入口点，负责初始化服务器连接并选择合适的通信模式。

#### 连接初始化流程

```mermaid
flowchart TD
Start([开始连接]) --> LoadConfig["加载服务器配置"]
LoadConfig --> CheckURL{"检查URL是否存在"}
CheckURL --> |不存在| SetError["设置状态为error"]
CheckURL --> |存在| CheckType["检查服务器类型"]
CheckType --> SSEMode{"type === 'sse'?"}
SSEMode --> |是| ProbeSSE["探测SSE连接"]
SSEMode --> |否| HTTPMode{"type === 'http' 或 'streamable_http'?"}
ProbeSSE --> ProbeResponse["检查Content-Type"]
ProbeResponse --> IsJSON{"Content-Type包含application/json?"}
IsJSON --> |是| SwitchHTTP["切换到HTTP模式"]
IsJSON --> |否| SetupSSE["设置SSE连接"]
SetupSSE --> ListenEndpoint["监听endpoint事件"]
SwitchHTTP --> HTTPMode
HTTPMode --> |是| DirectHTTP["直接HTTP模式"]
DirectHTTP --> FetchTools["立即获取工具列表"]
SetError --> End([结束])
ListenEndpoint --> InitSession["初始化会话"]
InitSession --> FetchTools
FetchTools --> End
```

**图表来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L71-L150)

#### 服务器连接探测机制

系统实现了智能的服务器连接探测机制：

1. **SSE模式探测**: 发送GET请求并检查`Accept`头
2. **Content-Type检查**: 如果服务器返回`application/json`而非SSE流
3. **自动降级**: 将服务器切换到HTTP模式
4. **SSE流建立**: 成功时建立EventSource连接

**章节来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L101-L113)

### refreshToolsHttp方法详解

refreshToolsHttp方法专门处理HTTP模式下的工具列表获取，支持多种响应格式。

#### JSON-RPC请求构建

```mermaid
sequenceDiagram
participant MM as MCPManager
participant HTTP as HTTP客户端
participant SV as MCP服务器
MM->>MM : refreshToolsHttp(id)
MM->>HTTP : POST /tools/list
HTTP->>HTTP : 构建JSON-RPC请求
HTTP->>SV : {
"jsonrpc" : "2.0",
"id" : "随机ID",
"method" : "tools/list",
"params" : {}
}
SV-->>HTTP : 返回工具列表
HTTP-->>MM : 解析响应
MM->>MM : 处理多种响应格式
```

**图表来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L159-L168)

#### 响应格式处理策略

系统支持四种不同的响应格式：

| 格式 | 结构 | 用途 |
|------|------|------|
| 标准JSON-RPC | `{ "result": { "tools": [...] } }` | 完整的JSON-RPC响应 |
| 直接tools | `{ "tools": [...] }` | 简化的工具数组包装 |
| result为数组 | `{ "result": [...] }` | 直接返回工具数组 |
| 直接数组 | `[...]` | 最简化的数组格式 |

```mermaid
flowchart TD
Start([接收响应]) --> CheckError{"检查是否有error字段"}
CheckError --> |有| HandleError["设置状态为error<br/>清空工具列表"]
CheckError --> |无| CheckFormat["检查响应格式"]
CheckFormat --> Format1{"result.result.tools存在?"}
Format1 --> |是| Extract1["提取result.result.tools"]
Format1 --> |否| Format2{"result.tools存在?"}
Format2 --> |是| Extract2["提取result.tools"]
Format2 --> |否| Format3{"result为数组?"}
Format3 --> |是| Extract3["提取result"]
Format3 --> |否| Format4{"响应为数组?"}
Format4 --> |是| Extract4["提取整个数组"]
Format4 --> |否| WarnFormat["记录警告并清空工具列表"]
Extract1 --> ValidateTools{"验证工具数组有效?"}
Extract2 --> ValidateTools
Extract3 --> ValidateTools
Extract4 --> ValidateTools
ValidateTools --> |是| SetTools["设置服务器工具列表"]
ValidateTools --> |否| WarnFormat
HandleError --> End([结束])
SetTools --> End
WarnFormat --> End
```

**图表来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L181-L210)

**章节来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L152-L213)

### refreshTools方法分析

refreshTools方法根据服务器配置决定使用哪种工具刷新方式。

#### 调用路径决策

```mermaid
flowchart TD
Start([refreshTools调用]) --> CheckMode{"检查是否HTTP模式"}
CheckMode --> |是| CallHTTP["调用refreshToolsHttp"]
CheckMode --> |否| CheckSSE["检查SSE模式"]
CheckSSE --> CallSSE["调用sendRequest"]
CallSSE --> BuildRequest["构建tools/list请求"]
BuildRequest --> SendRequest["发送JSON-RPC请求"]
SendRequest --> WaitResponse["等待SSE响应"]
WaitResponse --> ParseResponse["解析响应"]
CallHTTP --> ParseHTTP["解析HTTP响应"]
ParseHTTP --> ValidateTools{"验证工具有效性"}
ParseResponse --> ValidateTools
ValidateTools --> |有效| UpdateTools["更新工具列表"]
ValidateTools --> |无效| LogError["记录错误"]
UpdateTools --> End([结束])
LogError --> End
```

**图表来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L287-L306)

**章节来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L287-L306)

### 服务器连接探测机制

系统实现了智能的服务器连接探测机制，确保与各种MCP服务器的兼容性。

#### 探测流程

```mermaid
sequenceDiagram
participant MM as MCPManager
participant HTTP as HTTP客户端
participant SV as MCP服务器
MM->>HTTP : GET /sse-endpoint
HTTP->>SV : 发送探测请求
SV-->>HTTP : 返回响应
alt 响应为SSE流
HTTP-->>MM : SSE连接建立
MM->>MM : 设置SSE模式
MM->>HTTP : 监听endpoint事件
HTTP-->>MM : endpoint事件
MM->>HTTP : POST /post-url
MM->>MM : 初始化会话
else 响应为JSON
HTTP-->>MM : application/json响应
MM->>MM : 检测到JSON响应
MM->>MM : 自动降级到HTTP模式
MM->>HTTP : POST /tools/list
HTTP-->>MM : 工具列表
MM->>MM : 解析并存储工具
end
```

**图表来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L101-L113)

**章节来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L101-L113)

## 依赖关系分析

```mermaid
graph TB
subgraph "核心依赖"
MM[MCPManager]
ES[EventSource]
CHROME[Chrome扩展API]
end
subgraph "消息传递"
MSG[消息处理器]
BG[后台进程]
UI[用户界面]
end
subgraph "配置管理"
STORAGE[Chrome存储]
CONFIG[MCP配置]
end
MM --> ES
MM --> CHROME
MSG --> MM
BG --> MSG
UI --> MSG
MM --> STORAGE
MM --> CONFIG
```

**图表来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L1-L530)
- [messages.js](file://background/messages.js#L1-L82)

**章节来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L1-L530)
- [messages.js](file://background/messages.js#L1-L82)

## 性能考虑

### 连接优化策略

1. **延迟初始化**: 仅在需要时建立SSE连接
2. **自动降级**: 当服务器不支持SSE时自动切换到HTTP模式
3. **缓存机制**: 已连接的服务器状态会被缓存
4. **超时处理**: 请求超时时间为10秒

### 内存管理

- 使用`disconnectAll()`方法清理EventSource连接
- 及时清理pending请求映射
- 合理的错误状态管理

## 故障排除指南

### 调试信息获取

系统提供了完整的调试接口，可通过`getDebugInfo()`方法获取服务器状态和工具列表信息。

#### 调试信息结构

| 字段 | 类型 | 描述 |
|------|------|------|
| status | string | 服务器连接状态 |
| type | string | 服务器类型 (sse/http/streamable_http) |
| url | string | 服务器URL |
| postUrl | string | POST端点URL |
| toolCount | number | 工具数量 |
| tools | array | 工具名称列表 |

#### 调试信息访问流程

```mermaid
sequenceDiagram
participant UI as 用户界面
participant MSG as 消息处理器
participant MM as MCPManager
participant DBG as 调试接口
UI->>MSG : 请求MCP状态
MSG->>MM : getDebugInfo()
MM->>DBG : 收集调试信息
DBG-->>MM : 返回调试数据
MM-->>MSG : 返回服务器状态
MSG-->>UI : 显示调试信息
```

**图表来源**
- [messages.js](file://background/messages.js#L63-L67)
- [mcp_manager.js](file://background/managers/mcp_manager.js#L389-L403)

**章节来源**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L389-L403)
- [messages.js](file://background/messages.js#L63-L67)

### 常见问题诊断

1. **服务器无法连接**
   - 检查服务器URL配置
   - 查看浏览器开发者工具网络面板
   - 验证服务器是否支持MCP协议

2. **工具列表为空**
   - 确认服务器已正确配置工具
   - 检查服务器响应格式
   - 使用调试接口查看具体错误

3. **SSE连接失败**
   - 服务器可能不支持SSE
   - 系统会自动降级到HTTP模式
   - 检查服务器日志

## 结论

MCP工具发现机制通过智能的连接管理和多格式响应处理，实现了对不同类型MCP服务器的广泛兼容性。其核心优势包括：

1. **自动模式选择**: 根据服务器能力自动选择最优通信模式
2. **灵活响应处理**: 支持多种JSON-RPC响应格式
3. **完善的调试支持**: 提供详细的服务器状态和工具信息
4. **健壮的错误处理**: 包容性设计确保与各种服务器的兼容

该机制为Gemini Nexus应用提供了可靠的MCP工具集成基础，支持用户在不同MCP服务器间无缝切换和使用。
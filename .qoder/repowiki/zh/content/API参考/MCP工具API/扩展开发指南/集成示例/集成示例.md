# 集成示例

<cite>
**本文档中引用的文件**  
- [mcp_controller.js](file://sandbox/controllers/mcp_controller.js)
- [mcp_manager.js](file://background/managers/mcp_manager.js)
- [tool_executor.js](file://background/handlers/session/prompt/tool_executor.js)
- [builder.js](file://background/handlers/session/prompt/builder.js)
- [preamble.js](file://background/handlers/session/prompt/preamble.js)
- [control_manager.js](file://background/managers/control_manager.js)
- [messages.js](file://background/messages.js)
- [session_manager.js](file://background/managers/session_manager.js)
- [settings.js](file://sandbox/ui/templates/settings.js)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [MCPController UI组件实现](#mcpcontroller-ui组件实现)
3. [MCPManager后端管理](#mcpmanager后端管理)
4. [工具包装与调用](#工具包装与调用)
5. [消息传递流程](#消息传递流程)
6. [系统提示与工具列表](#系统提示与工具列表)
7. [完整集成流程示例](#完整集成流程示例)

## 项目结构

```mermaid
graph TD
subgraph "前端 (Sandbox)"
MCPController[mcp_controller.js]
Settings[settings.js]
end
subgraph "后端 (Background)"
MCPManager[mcp_manager.js]
ControlManager[control_manager.js]
ToolExecutor[tool_executor.js]
SessionManager[session_manager.js]
Messages[messages.js]
end
MCPController --> |发送消息| Messages
Messages --> |处理请求| MCPManager
MCPManager --> |执行工具| ControlManager
SessionManager --> |构建提示| ToolExecutor
```

**Diagram sources**  
- [mcp_controller.js](file://sandbox/controllers/mcp_controller.js)
- [mcp_manager.js](file://background/managers/mcp_manager.js)
- [tool_executor.js](file://background/handlers/session/prompt/tool_executor.js)

**Section sources**  
- [mcp_controller.js](file://sandbox/controllers/mcp_controller.js)
- [mcp_manager.js](file://background/managers/mcp_manager.js)

## MCPController UI组件实现

MCPController负责在UI中处理MCP服务器选择和状态管理。它通过`initElements`方法初始化DOM元素，包括MCP选择器、服务器列表、标签容器等。

```mermaid
classDiagram
class MCPController {
+app : AppController
+selectedMcpIds : Set
+mcpServers : Object
+initElements()
+initListeners()
+togglePicker()
+openPicker()
+closePicker()
+requestMcpStatus()
+handleMcpStatus(servers)
+renderServerList()
+toggleMcpSelection(mcpId)
+selectMcp(mcpId)
+deselectMcp(mcpId)
+updateTagsUI()
+getSelectedMcpIds()
+hasMcpSelected()
+clearSelections()
+escapeHtml(text)
}
```

**Diagram sources**  
- [mcp_controller.js](file://sandbox/controllers/mcp_controller.js#L5-L221)

**Section sources**  
- [mcp_controller.js](file://sandbox/controllers/mcp_controller.js#L5-L221)

## MCPManager后端管理

MCPManager是后端管理核心，负责加载配置、连接服务器、获取工具列表和执行工具调用。它通过`init`方法初始化，自动连接启用的服务器。

```mermaid
sequenceDiagram
participant UI as 前端
participant MCPController as MCPController
participant Messages as messages.js
participant MCPManager as MCPManager
UI->>MCPController : 点击MCP按钮
MCPController->>MCPController : togglePicker()
MCPController->>Messages : requestMcpStatus()
Messages->>MCPManager : MCP_GET_STATUS
MCPManager->>MCPManager : getDebugInfo()
MCPManager-->>Messages : 返回服务器状态
Messages-->>MCPController : 返回服务器状态
MCPController->>MCPController : handleMcpStatus()
MCPController->>MCPController : renderServerList()
```

**Diagram sources**  
- [mcp_controller.js](file://sandbox/controllers/mcp_controller.js#L88-L93)
- [messages.js](file://background/messages.js#L63-L66)
- [mcp_manager.js](file://background/managers/mcp_manager.js#L389-L403)

**Section sources**  
- [mcp_manager.js](file://background/managers/mcp_manager.js#L2-L530)

## 工具包装与调用

Python脚本或Node.js服务可以通过MCP协议包装为工具。MCPManager支持多种响应格式，包括标准JSON-RPC格式、直接格式等。

```mermaid
flowchart TD
Start([开始]) --> LoadConfig["加载MCP配置"]
LoadConfig --> ConnectServer["连接服务器"]
ConnectServer --> CheckType["检查服务器类型"]
CheckType --> |SSE| ConnectSSE["建立SSE连接"]
CheckType --> |HTTP| UseHttp["使用HTTP模式"]
UseHttp --> FetchTools["获取工具列表"]
FetchTools --> ParseFormat["解析多种响应格式"]
ParseFormat --> StoreTools["存储工具信息"]
StoreTools --> End([完成])
ConnectSSE --> ReceiveEndpoint["接收POST URL"]
ReceiveEndpoint --> Initialize["初始化会话"]
Initialize --> ListTools["列出工具"]
ListTools --> StoreTools
```

**Diagram sources**  
- [mcp_manager.js](file://background/managers/mcp_manager.js#L71-L150)
- [mcp_manager.js](file://background/managers/mcp_manager.js#L153-L213)

**Section sources**  
- [mcp_manager.js](file://background/managers/mcp_manager.js#L153-L213)

## 消息传递流程

从前端选择到后端执行的完整消息传递流程涉及多个组件的协作。

```mermaid
sequenceDiagram
participant UI as 前端
participant MCPController as MCPController
participant Messages as messages.js
participant SessionManager as SessionManager
participant MCPManager as MCPManager
participant ControlManager as ControlManager
UI->>MCPController : 选择MCP服务器
MCPController->>MCPController : selectMcp(mcpId)
MCPController->>MCPController : updateTagsUI()
UI->>SessionManager : 发送请求
SessionManager->>MCPManager : getSystemPromptForServers()
MCPManager->>MCPManager : getAllTools()
MCPManager-->>SessionManager : 返回系统提示
SessionManager->>Gemini : 发送包含工具提示的请求
Gemini-->>SessionManager : 返回包含工具调用的响应
SessionManager->>MCPManager : executeTool(toolName, args)
MCPManager->>ControlManager : 执行具体操作
ControlManager-->>MCPManager : 返回执行结果
MCPManager-->>SessionManager : 返回工具执行结果
SessionManager->>Gemini : 发送结果
Gemini-->>SessionManager : 返回最终响应
SessionManager-->>UI : 显示最终结果
```

**Diagram sources**  
- [mcp_controller.js](file://sandbox/controllers/mcp_controller.js#L157-L167)
- [session_manager.js](file://background/managers/session_manager.js#L47-L118)
- [mcp_manager.js](file://background/managers/mcp_manager.js#L479-L525)

**Section sources**  
- [session_manager.js](file://background/managers/session_manager.js#L47-L118)

## 系统提示与工具列表

MCPManager提供`getAllTools`和`getSystemPrompt`方法为Gemini提供工具列表和系统提示。

```mermaid
flowchart TD
A[获取所有工具] --> B[遍历所有服务器]
B --> C{服务器有工具?}
C --> |是| D[添加工具到列表]
D --> E[添加_serverId]
E --> F[继续遍历]
C --> |否| F
F --> G{遍历完成?}
G --> |否| B
G --> |是| H[返回工具列表]
I[生成系统提示] --> J[获取所有工具]
J --> K{工具有内容?}
K --> |是| L[构建工具描述]
L --> M[添加工具名称和描述]
M --> N[添加参数模式]
N --> O[构建调用格式]
O --> P[返回系统提示]
K --> |否| Q[返回null]
```

**Diagram sources**  
- [mcp_manager.js](file://background/managers/mcp_manager.js#L407-L477)

**Section sources**  
- [mcp_manager.js](file://background/managers/mcp_manager.js#L407-L477)

## 完整集成流程示例

完整的MCP功能集成流程从前端UI交互开始，经过消息传递，到后端执行和结果返回。

```mermaid
sequenceDiagram
participant User as 用户
participant UI as UI组件
participant MCPController as MCPController
participant Background as Background脚本
participant MCPManager as MCPManager
participant Tool as 工具服务
User->>UI : 打开设置
UI->>UI : 显示MCP配置区域
User->>UI : 输入MCP服务器配置
UI->>Background : 保存MCP配置
Background->>MCPManager : loadConfig()
MCPManager->>MCPManager : 初始化服务器状态
Background->>MCPManager : connectServer()
MCPManager->>Tool : 探测服务器类型
Tool-->>MCPManager : 返回响应
MCPManager->>MCPManager : 确定连接模式
MCPManager->>Tool : 获取工具列表
Tool-->>MCPManager : 返回工具信息
MCPManager->>Background : 存储工具信息
User->>UI : 选择MCP服务器
UI->>MCPController : selectMcp()
MCPController->>Background : requestMcpStatus()
Background->>MCPManager : getDebugInfo()
MCPManager-->>Background : 返回服务器状态
Background-->>UI : 返回服务器状态
UI->>UI : 更新UI显示
User->>UI : 发送查询
UI->>Background : 发送请求
Background->>MCPManager : getSystemPromptForServers()
MCPManager-->>Background : 返回系统提示
Background->>Gemini : 发送包含工具提示的请求
Gemini-->>Background : 返回包含工具调用的响应
Background->>MCPManager : executeTool()
MCPManager->>Tool : 执行工具调用
Tool-->>MCPManager : 返回执行结果
MCPManager-->>Background : 返回工具执行结果
Background->>Gemini : 发送结果
Gemini-->>Background : 返回最终响应
Background-->>UI : 显示最终结果
UI->>User : 显示响应
```

**Diagram sources**  
- [settings.js](file://sandbox/ui/templates/settings.js#L75-L87)
- [mcp_controller.js](file://sandbox/controllers/mcp_controller.js)
- [mcp_manager.js](file://background/managers/mcp_manager.js)
- [session_manager.js](file://background/managers/session_manager.js)

**Section sources**  
- [settings.js](file://sandbox/ui/templates/settings.js#L75-L87)
- [mcp_controller.js](file://sandbox/controllers/mcp_controller.js)
- [mcp_manager.js](file://background/managers/mcp_manager.js)
- [session_manager.js](file://background/managers/session_manager.js)
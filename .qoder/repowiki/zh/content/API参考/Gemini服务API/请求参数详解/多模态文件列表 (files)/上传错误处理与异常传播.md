# ä¸Šä¼ é”™è¯¯å¤„ç†ä¸å¼‚å¸¸ä¼ æ’­

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [services/gemini_api.js](file://services/gemini_api.js)
- [services/upload.js](file://services/upload.js)
- [background/managers/session_manager.js](file://background/managers/session_manager.js)
- [background/controls/base.js](file://background/control/actions/base.js)
- [content/toolbar/ui/manager.js](file://content/toolbar/ui/manager.js)
- [sandbox/controllers/message_handler.js](file://sandbox/controllers/message_handler.js)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„æ¦‚è§ˆ](#é¡¹ç›®ç»“æ„æ¦‚è§ˆ)
3. [æ ¸å¿ƒç»„ä»¶åˆ†æ](#æ ¸å¿ƒç»„ä»¶åˆ†æ)
4. [æ¶æ„æ€»è§ˆ](#æ¶æ„æ€»è§ˆ)
5. [è¯¦ç»†ç»„ä»¶åˆ†æ](#è¯¦ç»†ç»„ä»¶åˆ†æ)
6. [ä¾èµ–å…³ç³»åˆ†æ](#ä¾èµ–å…³ç³»åˆ†æ)
7. [æ€§èƒ½è€ƒè™‘](#æ€§èƒ½è€ƒè™‘)
8. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
9. [ç»“è®º](#ç»“è®º)

## ç®€ä»‹

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æäº† Gemini Nexus æ‰©å±•ç¨‹åºä¸­æ–‡ä»¶ä¸Šä¼ è¿‡ç¨‹çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å…³é”®æ–¹é¢ï¼š

- `sendGeminiMessage` å‡½æ•°ä¸­å¯¹ `AbortError` çš„é€ä¼ å¤„ç†ç­–ç•¥
- `uploadFile` å‡½æ•°å¯¹ HTTP å“åº”çŠ¶æ€ç çš„æ£€æŸ¥é€»è¾‘
- ç½‘ç»œå¤±è´¥å’ŒæœåŠ¡å™¨é”™è¯¯çš„å¤„ç†æ–¹å¼
- å®é™…è°ƒè¯•å»ºè®®å’Œå‰ç«¯é”™è¯¯å±•ç¤ºæœ€ä½³å®è·µ

è¯¥ç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„é”™è¯¯ä¼ æ’­æœºåˆ¶ï¼Œç¡®ä¿ç”¨æˆ·å¯ä»¥ä¼˜é›…åœ°å–æ¶ˆæ“ä½œï¼ŒåŒæ—¶ä¸ºå„ç§å¼‚å¸¸æƒ…å†µæä¾›æ¸…æ™°çš„åé¦ˆã€‚

## é¡¹ç›®ç»“æ„æ¦‚è§ˆ

Gemini Nexus é‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½åˆ†å¸ƒåœ¨å¤šä¸ªå±‚æ¬¡ä¸­ï¼š

```mermaid
graph TB
subgraph "å‰ç«¯å±‚"
UI[ç”¨æˆ·ç•Œé¢]
MessageHandler[æ¶ˆæ¯å¤„ç†å™¨]
UIManager[UIç®¡ç†å™¨]
end
subgraph "ä¸šåŠ¡é€»è¾‘å±‚"
SessionManager[ä¼šè¯ç®¡ç†å™¨]
GeminiAPI[Gemini APIæœåŠ¡]
end
subgraph "æ•°æ®ä¼ è¾“å±‚"
UploadService[ä¸Šä¼ æœåŠ¡]
AuthService[è®¤è¯æœåŠ¡]
end
subgraph "åº•å±‚æœåŠ¡"
Utils[å·¥å…·å‡½æ•°]
Parser[å“åº”è§£æå™¨]
end
UI --> MessageHandler
MessageHandler --> SessionManager
SessionManager --> GeminiAPI
GeminiAPI --> UploadService
UploadService --> Utils
GeminiAPI --> Parser
SessionManager --> AuthService
```

**å›¾è¡¨æ¥æº**
- [services/gemini_api.js](file://services/gemini_api.js#L26-L230)
- [services/upload.js](file://services/upload.js#L7-L39)
- [background/managers/session_manager.js](file://background/managers/session_manager.js#L1-L200)

**ç« èŠ‚æ¥æº**
- [services/gemini_api.js](file://services/gemini_api.js#L1-L230)
- [services/upload.js](file://services/upload.js#L1-L40)
- [background/managers/session_manager.js](file://background/managers/session_manager.js#L1-L200)

## æ ¸å¿ƒç»„ä»¶åˆ†æ

### é”™è¯¯å¤„ç†ç­–ç•¥æ¦‚è¿°

ç³»ç»Ÿé‡‡ç”¨äº†åˆ†å±‚çš„é”™è¯¯å¤„ç†ç­–ç•¥ï¼Œä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š

1. **ç”¨æˆ·å–æ¶ˆæ“ä½œçš„ç‰¹æ®Šå¤„ç†**ï¼šé€šè¿‡ `AbortError` é€ä¼ å®ç°ä¼˜é›…çš„ç”¨æˆ·å–æ¶ˆ
2. **åˆ†ç±»é”™è¯¯å¤„ç†**ï¼šä¸åŒç±»å‹çš„é”™è¯¯é‡‡ç”¨ä¸åŒçš„å¤„ç†ç­–ç•¥
3. **å›½é™…åŒ–é”™è¯¯æ¶ˆæ¯**ï¼šæ”¯æŒä¸­è‹±æ–‡åŒè¯­é”™è¯¯æç¤º
4. **è‡ªåŠ¨é‡è¯•æœºåˆ¶**ï¼šé’ˆå¯¹è®¤è¯é—®é¢˜çš„æ™ºèƒ½é‡è¯•

### AbortError é€ä¼ æœºåˆ¶

ç³»ç»Ÿå¯¹ `AbortError` çš„ç‰¹æ®Šå¤„ç†æ˜¯å…¶ç”¨æˆ·ä½“éªŒçš„å…³é”®è®¾è®¡ï¼š

```mermaid
flowchart TD
Start([å¼€å§‹ä¸Šä¼ ]) --> CheckSignal["æ£€æŸ¥ AbortController ä¿¡å·"]
CheckSignal --> UploadFile["æ‰§è¡Œæ–‡ä»¶ä¸Šä¼ "]
UploadFile --> UploadSuccess{"ä¸Šä¼ æˆåŠŸ?"}
UploadSuccess --> |æ˜¯| ReturnURL["è¿”å›æ–‡ä»¶URL"]
UploadSuccess --> |å¦| CheckErrorType{"é”™è¯¯ç±»å‹æ£€æŸ¥"}
CheckErrorType --> IsAbortError{"æ˜¯å¦ä¸º AbortError?"}
IsAbortError --> |æ˜¯| ThrowAbort["é€ä¼  AbortError"]
IsAbortError --> |å¦| LogError["è®°å½•é”™è¯¯æ—¥å¿—"]
LogError --> ReThrow["é‡æ–°æŠ›å‡ºé”™è¯¯"]
ThrowAbort --> End([ç»“æŸ])
ReThrow --> End
ReturnURL --> End
```

**å›¾è¡¨æ¥æº**
- [services/gemini_api.js](file://services/gemini_api.js#L45-L56)
- [services/upload.js](file://services/upload.js#L30-L32)

**ç« èŠ‚æ¥æº**
- [services/gemini_api.js](file://services/gemini_api.js#L45-L56)
- [services/upload.js](file://services/upload.js#L30-L32)

## æ¶æ„æ€»è§ˆ

ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œæ¯å±‚éƒ½æœ‰æ˜ç¡®çš„èŒè´£åˆ†å·¥ï¼š

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant UI as ç”¨æˆ·ç•Œé¢
participant SM as ä¼šè¯ç®¡ç†å™¨
participant GA as Gemini API
participant US as ä¸Šä¼ æœåŠ¡
participant Server as æœåŠ¡å™¨
User->>UI : è§¦å‘ä¸Šä¼ æ“ä½œ
UI->>SM : å‘é€ä¸Šä¼ è¯·æ±‚
SM->>GA : è°ƒç”¨ sendGeminiMessage
GA->>US : è°ƒç”¨ uploadFile
US->>Server : å‘é€æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
Server-->>US : è¿”å›å“åº”
US-->>GA : è¿”å›æ–‡ä»¶æ ‡è¯†ç¬¦
GA-->>SM : è¿”å›å¤„ç†ç»“æœ
SM-->>UI : æ˜¾ç¤ºæœ€ç»ˆç»“æœ
Note over User,Server : ç”¨æˆ·å¯éšæ—¶å–æ¶ˆæ“ä½œ
User->>SM : å–æ¶ˆè¯·æ±‚
SM->>GA : ä¼ é€’å–æ¶ˆä¿¡å·
GA->>US : ä¸­æ–­ä¸Šä¼ 
US-->>GA : æŠ›å‡º AbortError
GA-->>SM : é€ä¼  AbortError
SM-->>UI : æ˜¾ç¤ºå–æ¶ˆçŠ¶æ€
```

**å›¾è¡¨æ¥æº**
- [background/managers/session_manager.js](file://background/managers/session_manager.js#L21-L147)
- [services/gemini_api.js](file://services/gemini_api.js#L26-L230)
- [services/upload.js](file://services/upload.js#L7-L39)

## è¯¦ç»†ç»„ä»¶åˆ†æ

### sendGeminiMessage å‡½æ•°çš„é”™è¯¯å¤„ç†

#### æ–‡ä»¶ä¸Šä¼ é˜¶æ®µçš„å¼‚å¸¸å¤„ç†

`sendGeminiMessage` å‡½æ•°åœ¨æ–‡ä»¶ä¸Šä¼ é˜¶æ®µå®ç°äº†ç²¾ç»†çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```mermaid
flowchart TD
Start([å¼€å§‹æ–‡ä»¶ä¸Šä¼ ]) --> ParallelUpload["å¹¶å‘ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶"]
ParallelUpload --> UploadLoop["éå†æ¯ä¸ªæ–‡ä»¶"]
UploadLoop --> TryUpload["å°è¯•ä¸Šä¼ å•ä¸ªæ–‡ä»¶"]
TryUpload --> UploadSuccess{"ä¸Šä¼ æˆåŠŸ?"}
UploadSuccess --> |æ˜¯| AddToList["æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨"]
UploadSuccess --> |å¦| CheckAbort{"AbortError?"}
CheckAbort --> |æ˜¯| ThrowAbort["é€ä¼  AbortError"]
CheckAbort --> |å¦| LogError["è®°å½•é”™è¯¯æ—¥å¿—"]
LogError --> ReThrow["é‡æ–°æŠ›å‡ºé”™è¯¯"]
AddToList --> NextFile{"è¿˜æœ‰æ–‡ä»¶?"}
NextFile --> |æ˜¯| UploadLoop
NextFile --> |å¦| Continue["ç»§ç»­åç»­æµç¨‹"]
ThrowAbort --> End([ç»“æŸ])
ReThrow --> End
Continue --> End
```

**å›¾è¡¨æ¥æº**
- [services/gemini_api.js](file://services/gemini_api.js#L44-L56)

#### æµå¼å“åº”å¤„ç†çš„å¼‚å¸¸æ•è·

åœ¨æµå¼å“åº”å¤„ç†é˜¶æ®µï¼Œç³»ç»ŸåŒæ ·å®ç°äº†å¯¹ `AbortError` çš„é€ä¼ ï¼š

```mermaid
flowchart TD
Start([å¼€å§‹æµå¼å¤„ç†]) --> ReadLoop["å¾ªç¯è¯»å–å“åº”æµ"]
ReadLoop --> ReadChunk["è¯»å–å“åº”å—"]
ReadChunk --> ChunkAvailable{"æœ‰å“åº”å—?"}
ChunkAvailable --> |å¦| End([ç»“æŸ])
ChunkAvailable --> |æ˜¯| ProcessChunk["å¤„ç†å“åº”å—"]
ProcessChunk --> CheckAbort{"AbortError?"}
CheckAbort --> |æ˜¯| ThrowAbort["é€ä¼  AbortError"]
CheckAbort --> |å¦| CheckLogin{"æ£€æŸ¥ç™»å½•çŠ¶æ€"}
CheckLogin --> LoginError{"ç™»å½•å¤±æ•ˆ?"}
LoginError --> |æ˜¯| ThrowLogin["æŠ›å‡ºç™»å½•é”™è¯¯"]
LoginError --> |å¦| Continue["ç»§ç»­å¤„ç†"]
ThrowAbort --> End
ThrowLogin --> End
Continue --> ReadLoop
```

**å›¾è¡¨æ¥æº**
- [services/gemini_api.js](file://services/gemini_api.js#L165-L201)

**ç« èŠ‚æ¥æº**
- [services/gemini_api.js](file://services/gemini_api.js#L44-L56)
- [services/gemini_api.js](file://services/gemini_api.js#L165-L201)

### uploadFile å‡½æ•°çš„çŠ¶æ€ç æ£€æŸ¥é€»è¾‘

#### HTTP å“åº”éªŒè¯æœºåˆ¶

`uploadFile` å‡½æ•°å®ç°äº†ä¸¥æ ¼çš„ HTTP å“åº”çŠ¶æ€ç æ£€æŸ¥ï¼š

```mermaid
flowchart TD
Start([å¼€å§‹ä¸Šä¼ ]) --> SendRequest["å‘é€ä¸Šä¼ è¯·æ±‚"]
SendRequest --> CheckResponse{"æ£€æŸ¥å“åº”çŠ¶æ€"}
CheckResponse --> ResponseOK{"response.ok ä¸ºçœŸ?"}
ResponseOK --> |æ˜¯| ReadBody["è¯»å–å“åº”ä½“"]
ResponseOK --> |å¦| ThrowError["æŠ›å‡ºé”™è¯¯"]
ReadBody --> ParseResponse["è§£æå“åº”æ–‡æœ¬"]
ParseResponse --> ReturnURL["è¿”å›æ–‡ä»¶URL"]
ThrowError --> End([ç»“æŸ])
ReturnURL --> End
```

**å›¾è¡¨æ¥æº**
- [services/upload.js](file://services/upload.js#L21-L39)

#### é”™è¯¯åˆ†ç±»å¤„ç†

ç³»ç»Ÿæ ¹æ®é”™è¯¯ç±»å‹é‡‡ç”¨ä¸åŒçš„å¤„ç†ç­–ç•¥ï¼š

| é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ | ç¤ºä¾‹åœºæ™¯ |
|---------|---------|---------|
| AbortError | é€ä¼ ç»™è°ƒç”¨æ–¹ | ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆä¸Šä¼  |
| ç½‘ç»œé”™è¯¯ | è®°å½•æ—¥å¿—å¹¶é‡æ–°æŠ›å‡º | ç½‘ç»œè¿æ¥ä¸­æ–­ |
| æœåŠ¡å™¨é”™è¯¯ | è®°å½•çŠ¶æ€ç å¹¶é‡æ–°æŠ›å‡º | 500, 503ç­‰æœåŠ¡å™¨é”™è¯¯ |
| è§£æé”™è¯¯ | è®°å½•é”™è¯¯å¹¶é‡æ–°æŠ›å‡º | å“åº”æ ¼å¼ä¸æ­£ç¡® |

**ç« èŠ‚æ¥æº**
- [services/upload.js](file://services/upload.js#L30-L32)

### ä¼šè¯ç®¡ç†å™¨çš„ç»¼åˆé”™è¯¯å¤„ç†

#### å¤šå±‚é”™è¯¯å¤„ç†ç­–ç•¥

ä¼šè¯ç®¡ç†å™¨å®ç°äº†å¤šå±‚é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```mermaid
flowchart TD
Start([å¼€å§‹è¯·æ±‚]) --> CreateAbort["åˆ›å»º AbortController"]
CreateAbort --> SendRequest["å‘é€è¯·æ±‚"]
SendRequest --> TryCatch{"try-catch åŒ…è£…"}
TryCatch --> InnerTry{"å†…éƒ¨ try"}
InnerTry --> ProcessResponse["å¤„ç†å“åº”"]
ProcessResponse --> Success{"å¤„ç†æˆåŠŸ?"}
Success --> |æ˜¯| ReturnSuccess["è¿”å›æˆåŠŸç»“æœ"]
Success --> |å¦| CheckLogin{"æ£€æŸ¥ç™»å½•é”™è¯¯"}
CheckLogin --> LoginError{"ç™»å½•ç›¸å…³é”™è¯¯?"}
LoginError --> |æ˜¯| RotateAccount["è½®æ¢è´¦æˆ·"]
LoginError --> |å¦| CheckAbort{"AbortError?"}
CheckAbort --> |æ˜¯| ReturnNull["è¿”å›ç©ºå€¼"]
CheckAbort --> |å¦| HandleOtherError["å¤„ç†å…¶ä»–é”™è¯¯"]
RotateAccount --> Retry["é‡è¯•è¯·æ±‚"]
Retry --> InnerTry
HandleOtherError --> ReturnError["è¿”å›é”™è¯¯ç»“æœ"]
ReturnSuccess --> End([ç»“æŸ])
ReturnNull --> End
ReturnError --> End
```

**å›¾è¡¨æ¥æº**
- [background/managers/session_manager.js](file://background/managers/session_manager.js#L28-L147)

**ç« èŠ‚æ¥æº**
- [background/managers/session_manager.js](file://background/managers/session_manager.js#L149-L201)

## ä¾èµ–å…³ç³»åˆ†æ

### ç»„ä»¶é—´ä¾èµ–å…³ç³»

```mermaid
graph TB
subgraph "é”™è¯¯å¤„ç†æ ¸å¿ƒ"
AbortController[AbortController]
ErrorTypes[é”™è¯¯ç±»å‹å®šä¹‰]
end
subgraph "ä¸Šä¼ æœåŠ¡å±‚"
UploadService[uploadFile]
GeminiAPI[sendGeminiMessage]
end
subgraph "ä¼šè¯ç®¡ç†å±‚"
SessionManager[GeminiSessionManager]
AuthManager[AuthManager]
end
subgraph "å‰ç«¯æ˜¾ç¤ºå±‚"
UIManager[ToolbarUI]
MessageHandler[MessageHandler]
end
AbortController --> UploadService
AbortController --> GeminiAPI
ErrorTypes --> SessionManager
UploadService --> SessionManager
GeminiAPI --> SessionManager
SessionManager --> UIManager
SessionManager --> MessageHandler
AuthManager --> SessionManager
```

**å›¾è¡¨æ¥æº**
- [services/gemini_api.js](file://services/gemini_api.js#L26-L230)
- [services/upload.js](file://services/upload.js#L7-L39)
- [background/managers/session_manager.js](file://background/managers/session_manager.js#L1-L200)

### é”™è¯¯ä¼ æ’­è·¯å¾„

ç³»ç»Ÿå®ç°äº†æ¸…æ™°çš„é”™è¯¯ä¼ æ’­è·¯å¾„ï¼š

```mermaid
sequenceDiagram
participant UI as ç”¨æˆ·ç•Œé¢
participant SM as ä¼šè¯ç®¡ç†å™¨
participant GA as Gemini API
participant US as ä¸Šä¼ æœåŠ¡
participant Server as æœåŠ¡å™¨
Note over UI,Server : æ­£å¸¸æµç¨‹
UI->>SM : å‘èµ·è¯·æ±‚
SM->>GA : è°ƒç”¨API
GA->>US : ä¸Šä¼ æ–‡ä»¶
US->>Server : ä¸Šä¼ è¯·æ±‚
Server-->>US : æˆåŠŸå“åº”
US-->>GA : æ–‡ä»¶æ ‡è¯†ç¬¦
GA-->>SM : å¤„ç†ç»“æœ
SM-->>UI : æˆåŠŸæ¶ˆæ¯
Note over UI,Server : é”™è¯¯æµç¨‹
UI->>SM : å–æ¶ˆè¯·æ±‚
SM->>GA : ä¼ é€’å–æ¶ˆä¿¡å·
GA->>US : ä¸­æ–­ä¸Šä¼ 
US-->>GA : AbortError
GA-->>SM : é€ä¼ AbortError
SM-->>UI : å–æ¶ˆçŠ¶æ€
```

**å›¾è¡¨æ¥æº**
- [background/managers/session_manager.js](file://background/managers/session_manager.js#L204-L211)
- [services/gemini_api.js](file://services/gemini_api.js#L52-L54)

**ç« èŠ‚æ¥æº**
- [background/managers/session_manager.js](file://background/managers/session_manager.js#L204-L211)
- [services/gemini_api.js](file://services/gemini_api.js#L52-L54)

## æ€§èƒ½è€ƒè™‘

### å¹¶å‘ä¸Šä¼ ä¼˜åŒ–

ç³»ç»Ÿé‡‡ç”¨å¹¶å‘ä¸Šä¼ ç­–ç•¥æ¥æå‡æ€§èƒ½ï¼š

- **å¹¶è¡Œå¤„ç†**ï¼šå¤šä¸ªæ–‡ä»¶åŒæ—¶ä¸Šä¼ ï¼Œå‡å°‘æ€»ç­‰å¾…æ—¶é—´
- **èµ„æºå¤ç”¨**ï¼šå…±äº«ç›¸åŒçš„ `AbortController` ä¿¡å·
- **å†…å­˜ç®¡ç†**ï¼šåŠæ—¶é‡Šæ”¾ä¸Šä¼ è¿‡ç¨‹ä¸­çš„ä¸´æ—¶èµ„æº

### é”™è¯¯å¤„ç†æ€§èƒ½å½±å“

åˆç†çš„é”™è¯¯å¤„ç†ç­–ç•¥å¯¹æ€§èƒ½çš„å½±å“ï¼š

| å¤„ç†ç­–ç•¥ | æ€§èƒ½å½±å“ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|
| AbortError é€ä¼  | å‡ ä¹æ— é¢å¤–å¼€é”€ | ç”¨æˆ·å–æ¶ˆæ“ä½œ |
| åŒæ­¥é”™è¯¯è®°å½• | è½»å¾®å»¶è¿Ÿ | éå…³é”®é”™è¯¯ |
| å¼‚æ­¥é”™è¯¯å¤„ç† | å¯å¿½ç•¥å»¶è¿Ÿ | ä¸¥é‡é”™è¯¯ |
| è‡ªåŠ¨é‡è¯• | æ˜¾è‘—å»¶è¿Ÿ | è®¤è¯ç›¸å…³é”™è¯¯ |

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜è¯Šæ–­

#### ä¸Šä¼ è¶…æ—¶é—®é¢˜

**ç—‡çŠ¶è¡¨ç°**ï¼š
- ä¸Šä¼ è¿›åº¦åœæ»
- æ§åˆ¶å°å‡ºç°ç½‘ç»œè¶…æ—¶é”™è¯¯
- ç”¨æˆ·ç•Œé¢æ˜¾ç¤ºåŠ è½½çŠ¶æ€

**è¯Šæ–­æ­¥éª¤**ï¼š
1. æ£€æŸ¥ç½‘ç»œè¿æ¥ç¨³å®šæ€§
2. æŸ¥çœ‹æœåŠ¡å™¨å“åº”æ—¶é—´
3. éªŒè¯æ–‡ä»¶å¤§å°é™åˆ¶
4. æ£€æŸ¥æµè§ˆå™¨ç¼“å­˜è®¾ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¢åŠ è¶…æ—¶æ—¶é—´é…ç½®
- å®ç°æ–­ç‚¹ç»­ä¼ åŠŸèƒ½
- æä¾›é‡è¯•æœºåˆ¶

#### è®¤è¯å¤±æ•ˆé—®é¢˜

**ç—‡çŠ¶è¡¨ç°**ï¼š
- å“åº”åŒ…å«ç™»å½•é¡µé¢å†…å®¹
- å‡ºç° "æœªç™»å½•" æˆ– "Session expired" é”™è¯¯
- è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µé¢

**è¯Šæ–­æ­¥éª¤**ï¼š
1. éªŒè¯è®¤è¯ä»¤ç‰Œæœ‰æ•ˆæ€§
2. æ£€æŸ¥ä¼šè¯çŠ¶æ€
3. ç¡®è®¤è´¦æˆ·æƒé™
4. éªŒè¯å¤šè´¦æˆ·åˆ‡æ¢é€»è¾‘

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®ç°è‡ªåŠ¨è®¤è¯åˆ·æ–°
- æä¾›æ‰‹åŠ¨ç™»å½•å…¥å£
- å¢åŠ é‡è¯•æœºåˆ¶

#### ç½‘ç»œå¤±è´¥é—®é¢˜

**ç—‡çŠ¶è¡¨ç°**ï¼š
- è¿æ¥è¢«æ‹’ç»
- è¯·æ±‚è¶…æ—¶
- DNS è§£æå¤±è´¥

**è¯Šæ–­æ­¥éª¤**ï¼š
1. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
2. éªŒè¯ä»£ç†é…ç½®
3. ç¡®è®¤æœåŠ¡å™¨å¯ç”¨æ€§
4. æ£€æŸ¥æµè§ˆå™¨æ‰©å±•å†²çª

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®ç°ç½‘ç»œçŠ¶æ€æ£€æµ‹
- æä¾›ç¦»çº¿æ¨¡å¼
- å¢åŠ é‡è¿æœºåˆ¶

### å‰ç«¯é”™è¯¯å±•ç¤ºæœ€ä½³å®è·µ

#### ç”¨æˆ·ä½“éªŒä¼˜åŒ–

**é”™è¯¯æ¶ˆæ¯è®¾è®¡åŸåˆ™**ï¼š
- **æ¸…æ™°æ˜“æ‡‚**ï¼šä½¿ç”¨ç®€å•æ˜äº†çš„è¯­è¨€
- **æä¾›è§£å†³æ–¹æ¡ˆ**ï¼šæŒ‡å¯¼ç”¨æˆ·å¦‚ä½•è§£å†³é—®é¢˜
- **ä¿æŒä¸€è‡´æ€§**ï¼šç»Ÿä¸€çš„é”™è¯¯æ ·å¼å’Œå¸ƒå±€
- **åŠæ—¶åé¦ˆ**ï¼šå¿«é€Ÿæ˜¾ç¤ºé”™è¯¯çŠ¶æ€

**é”™è¯¯å±•ç¤ºç»„ä»¶**ï¼š

```mermaid
classDiagram
class ErrorDisplay {
+showError(message)
+showSuccess(message)
+showWarning(message)
+clearMessage()
}
class UIErrorManager {
+displayError(error)
+displayNetworkError(error)
+displayAuthError(error)
+displayTimeoutError(error)
}
class MessageHandler {
+handleGeminiReply(request)
+handleStreamUpdate(request)
+showError(text)
}
ErrorDisplay <|-- UIErrorManager
UIErrorManager --> MessageHandler : "æ›´æ–°UIçŠ¶æ€"
```

**å›¾è¡¨æ¥æº**
- [content/toolbar/ui/manager.js](file://content/toolbar/ui/manager.js#L197-L200)
- [sandbox/controllers/message_handler.js](file://sandbox/controllers/message_handler.js#L231-L280)

#### å›½é™…åŒ–é”™è¯¯å¤„ç†

ç³»ç»Ÿæ”¯æŒä¸­è‹±æ–‡åŒè¯­é”™è¯¯æ¶ˆæ¯ï¼š

**ä¸­æ–‡é”™è¯¯æ¶ˆæ¯ç¤ºä¾‹**ï¼š
- "ğŸ”‘ è´¦å· (Index: ${currentIndex}) æœªç™»å½•æˆ–ä¼šè¯å·²è¿‡æœŸã€‚"
- "â³ è¯·æ±‚è¿‡äºé¢‘ç¹ï¼ŒGemini æš‚æ—¶é™åˆ¶äº†è®¿é—®ã€‚"
- "ğŸ”Œ æœåŠ¡å™¨æ— å“åº”ã€‚"

**è‹±æ–‡é”™è¯¯æ¶ˆæ¯ç¤ºä¾‹**ï¼š
- "ğŸ”‘ Account (Index: ${currentIndex}) not logged in."
- "â³ Too many requests. Gemini has temporarily limited access."
- "ğŸ”Œ No response from server."

**ç« èŠ‚æ¥æº**
- [background/managers/session_manager.js](file://background/managers/session_manager.js#L159-L192)
- [content/toolbar/ui/manager.js](file://content/toolbar/ui/manager.js#L197-L200)

### è°ƒè¯•æŠ€å·§å’Œå·¥å…·

#### å¼€å‘è€…å·¥å…·ä½¿ç”¨

**æµè§ˆå™¨å¼€å‘è€…å·¥å…·**ï¼š
- **ç½‘ç»œé¢æ¿**ï¼šç›‘æ§ä¸Šä¼ è¯·æ±‚å’Œå“åº”
- **æ§åˆ¶å°**ï¼šæŸ¥çœ‹é”™è¯¯æ—¥å¿—å’Œè­¦å‘Š
- **æºç é¢æ¿**ï¼šè°ƒè¯• JavaScript ä»£ç 
- **åº”ç”¨é¢æ¿**ï¼šæ£€æŸ¥å­˜å‚¨çš„æ•°æ®

**æ—¥å¿—è®°å½•ç­–ç•¥**ï¼š
- å…³é”®æ“ä½œæ·»åŠ æ—¥å¿—æ ‡è®°
- é”™è¯¯å‘ç”Ÿæ—¶è®°å½•å®Œæ•´ä¸Šä¸‹æ–‡
- æ€§èƒ½æŒ‡æ ‡ç›‘æ§å’Œè®°å½•
- ç”¨æˆ·è¡Œä¸ºè¿½è¸ª

#### æ€§èƒ½ç›‘æ§

**å…³é”®æ€§èƒ½æŒ‡æ ‡**ï¼š
- ä¸Šä¼ é€Ÿåº¦å’ŒæˆåŠŸç‡
- å“åº”æ—¶é—´åˆ†å¸ƒ
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- CPU å ç”¨ç‡

**ç›‘æ§å·¥å…·æ¨è**ï¼š
- Chrome DevTools Performance é¢æ¿
- Lighthouse æ€§èƒ½å®¡è®¡
- WebPageTest åœ¨çº¿æµ‹è¯•
- è‡ªå®šä¹‰æ€§èƒ½è®¡æ•°å™¨

## ç»“è®º

Gemini Nexus çš„æ–‡ä»¶ä¸Šä¼ é”™è¯¯å¤„ç†æœºåˆ¶å±•ç°äº†ç°ä»£ Web åº”ç”¨çš„ä¼˜ç§€å®è·µï¼š

### æ ¸å¿ƒä¼˜åŠ¿

1. **ä¼˜é›…çš„ç”¨æˆ·å–æ¶ˆ**ï¼šé€šè¿‡ `AbortError` é€ä¼ å®ç°å³æ—¶å“åº”
2. **åˆ†å±‚é”™è¯¯å¤„ç†**ï¼šä¸åŒå±‚çº§é‡‡ç”¨æœ€é€‚åˆçš„å¤„ç†ç­–ç•¥
3. **å›½é™…åŒ–æ”¯æŒ**ï¼šæä¾›å¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯
4. **å¥å£®çš„æ¢å¤æœºåˆ¶**ï¼šé’ˆå¯¹è®¤è¯é—®é¢˜çš„æ™ºèƒ½é‡è¯•

### è®¾è®¡äº®ç‚¹

- **ä¿¡å·é©±åŠ¨çš„å–æ¶ˆæœºåˆ¶**ï¼šç¡®ä¿ç”¨æˆ·æ“ä½œçš„å®æ—¶å“åº”
- **çŠ¶æ€ç ä¸¥æ ¼éªŒè¯**ï¼šé˜²æ­¢é”™è¯¯å“åº”è¢«è¯¯è®¤ä¸ºæˆåŠŸ
- **é”™è¯¯åˆ†ç±»å¤„ç†**ï¼šä¸ºä¸åŒç±»å‹é”™è¯¯æä¾›ä¸“é—¨çš„å¤„ç†é€»è¾‘
- **UI çŠ¶æ€åŒæ­¥**ï¼šç¡®ä¿å‰ç«¯ç•Œé¢ä¸åå°çŠ¶æ€ä¸€è‡´

### æ”¹è¿›å»ºè®®

1. **å¢å¼ºé”™è¯¯åˆ†ç±»**ï¼šåŒºåˆ†ç½‘ç»œè¶…æ—¶å’ŒæœåŠ¡å™¨é”™è¯¯
2. **å®ç°æ–­ç‚¹ç»­ä¼ **ï¼šæ”¯æŒå¤§æ–‡ä»¶çš„ä¸­æ–­æ¢å¤
3. **å¢åŠ é‡è¯•ç­–ç•¥**ï¼šä¸ºä¸´æ—¶æ€§é”™è¯¯æä¾›è‡ªåŠ¨é‡è¯•
4. **ä¼˜åŒ–é”™è¯¯å±•ç¤º**ï¼šæä¾›æ›´ä¸°å¯Œçš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³æ–¹æ¡ˆ

è¯¥ç³»ç»Ÿçš„é”™è¯¯å¤„ç†æœºåˆ¶ä¸ºæ„å»ºå¯é çš„ Web åº”ç”¨æä¾›äº†ä¼˜ç§€çš„å‚è€ƒæ¨¡æ¿ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¼‚æ­¥æ“ä½œå’Œç”¨æˆ·äº¤äº’æ–¹é¢å±•ç°äº†å“è¶Šçš„è®¾è®¡ç†å¿µã€‚
# 开发指南

<cite>
**本文档中引用的文件**   
- [package.json](file://package.json)
- [manifest.json](file://manifest.json)
- [README.md](file://README.md)
- [debug_regex.js](file://debug_regex.js)
- [background/index.js](file://background/index.js)
- [content/index.js](file://content/index.js)
- [sandbox/index.js](file://sandbox/index.js)
- [background/managers/mcp_manager.js](file://background/managers/mcp_manager.js)
- [background/handlers/session/prompt/tool_executor.js](file://background/handlers/session/prompt/tool_executor.js)
- [content/toolbar/controller.js](file://content/toolbar/controller.js)
- [services/gemini_api.js](file://services/gemini_api.js)
- [background/control/actions.js](file://background/control/actions.js)
- [background/control/actions/base.js](file://background/control/actions/base.js)
- [background/managers/control_manager.js](file://background/managers/control_manager.js)
- [background/handlers/session/prompt/builder.js](file://background/handlers/session/prompt/builder.js)
- [sandbox/controllers/mcp_controller.js](file://sandbox/controllers/mcp_controller.js)
</cite>

## 目录
1. [开发环境配置](#开发环境配置)
2. [构建工具链与开发服务器](#构建工具链与开发服务器)
3. [manifest.json配置详解](#manifestjson配置详解)
4. [代码风格与测试策略](#代码风格与测试策略)
5. [调试技巧](#调试技巧)
6. [功能扩展开发](#功能扩展开发)
7. [代码提交规范与审查流程](#代码提交规范与审查流程)
8. [性能优化建议](#性能优化建议)
9. [安全最佳实践](#安全最佳实践)
10. [MCP协议扩展与UI组件开发](#mcp协议扩展与ui组件开发)

## 开发环境配置

本项目为Chrome扩展程序，基于现代前端技术栈构建。开发者需要配置以下环境以进行开发和调试。

首先，确保已安装Node.js（建议v16+）和npm。克隆项目仓库后，通过以下命令安装依赖：

```bash
npm install
```

项目采用模块化架构，主要分为以下几个核心部分：
- **background**: Service Worker，负责API调用、会话管理和MCP协议处理
- **content**: Content Scripts，注入到网页中实现浮动工具栏和文本选中功能
- **sandbox**: 沙盒环境，用于安全地渲染Markdown和执行第三方库
- **sidepanel**: 侧边栏主界面，提供与Gemini的对话界面
- **services**: 封装Gemini API和其他外部服务

**Section sources**
- [README.md](file://README.md#L28-L49)
- [package.json](file://package.json#L1-L24)

## 构建工具链与开发服务器

项目采用Vite作为构建工具链，提供快速的开发服务器启动和热重载功能。

### Vite配置与使用

Vite在`package.json`中配置了三个主要脚本：
- `dev`: 启动开发服务器
- `build`: 构建生产版本
- `preview`: 预览生产构建

```json
"scripts": {
  "dev": "vite",
  "build": "vite build",
  "preview": "vite preview"
}
```

开发服务器通过`npm run dev`命令启动，Vite会自动处理模块导入、代码转换和热更新。由于Chrome扩展的特殊性，开发服务器主要提供文件服务，实际加载需要在Chrome浏览器中手动完成。

### 热重载机制

本项目通过Chrome扩展的"开发者模式"实现热重载。当代码发生变化时，Vite会重新构建相关文件，开发者只需在`chrome://extensions/`页面点击"重新加载"按钮即可应用更改。Content Scripts和Service Worker的更新会自动生效。

**Section sources**
- [package.json](file://package.json#L6-L9)
- [README.md](file://README.md#L28-L49)

## manifest.json配置详解

`manifest.json`是Chrome扩展的核心配置文件，定义了扩展的元数据、权限、资源和行为。

### 核心配置项

```json
{
  "manifest_version": 3,
  "name": "Gemini Nexus",
  "version": "4.0.0",
  "permissions": ["sidePanel", "storage", "contextMenus", "scripting", "alarms", "debugger", "downloads"],
  "host_permissions": [
    "https://gemini.google.com/*",
    "<all_urls>"
  ],
  "background": {
    "service_worker": "background/index.js",
    "type": "module"
  },
  "side_panel": {
    "default_path": "sidepanel/index.html"
  },
  "sandbox": {
    "pages": ["sandbox/index.html"]
  },
  "content_scripts": [
    {
      "matches": ["<all_urls>"],
      "js": [
        "content/overlay.js",
        "content/toolbar/icons.js",
        "content/toolbar/styles/core.js",
        "content/toolbar/styles/widget.js",
        "content/toolbar/styles/panel/layout.js",
        "content/toolbar/styles/panel/header.js",
        "content/toolbar/styles/panel/body.js",
        "content/toolbar/styles/panel/footer.js",
        "content/toolbar/styles/panel/index.js",
        "content/toolbar/styles/markdown.js",
        "content/toolbar/styles/index.js",
        "content/toolbar/bridge.js",
        "content/toolbar/utils/drag.js",
        "content/toolbar/i18n.js",
        "content/toolbar/templates.js",
        "content/toolbar/view/utils.js",
        "content/toolbar/view/widget.js",
        "content/toolbar/view/window.js",
        "content/toolbar/view/dom.js",
        "content/toolbar/view/index.js",
        "content/toolbar/events.js",
        "content/toolbar/ui/grammar.js",
        "content/toolbar/ui/renderer.js",
        "content/toolbar/ui/actions_delegate.js",
        "content/toolbar/ui/code_copy.js",
        "content/toolbar/ui/manager.js",
        "content/toolbar/actions.js",
        "content/toolbar/image.js",
        "content/toolbar/stream.js",
        "content/toolbar/utils/input.js",
        "content/selection.js",
        "content/toolbar/dispatch.js",
        "content/toolbar/crop.js",
        "content/toolbar/controller.js",
        "content/index.js"
      ],
      "run_at": "document_end"
    }
  ],
  "web_accessible_resources": [
    {
      "resources": ["logo.png", "sandbox/index.html"],
      "matches": ["<all_urls>"]
    }
  ],
  "content_security_policy": {
    "extension_pages": "script-src 'self'; object-src 'self'",
    "sandbox": "sandbox allow-scripts allow-forms allow-popups allow-modals; script-src 'self' 'unsafe-inline'; img-src https: http: data: blob:; media-src https: http: data: blob:;"
  }
}
```

### 关键配置说明

- **manifest_version**: 使用MV3，支持Service Worker和现代权限模型
- **permissions**: 声明扩展所需权限，包括sidePanel、storage、contextMenus等
- **host_permissions**: 定义扩展可以访问的主机，`<all_urls>`允许访问所有网站
- **background**: 配置Service Worker，处理后台逻辑
- **side_panel**: 设置侧边栏默认页面
- **sandbox**: 定义沙盒页面，用于安全执行第三方库
- **content_scripts**: 注入到匹配页面的脚本，`run_at: "document_end"`确保在DOM加载完成后执行
- **web_accessible_resources**: 声明可被网页访问的资源
- **content_security_policy**: 内容安全策略，限制脚本执行来源

**Section sources**
- [manifest.json](file://manifest.json#L1-L93)

## 代码风格与测试策略

### 代码风格指南

项目遵循现代JavaScript最佳实践，采用ES模块语法。关键风格规范包括：
- 使用`const`和`let`代替`var`
- 优先使用箭头函数
- 采用模块化设计，每个文件职责单一
- 使用有意义的变量和函数命名
- 添加必要的JSDoc注释

### 测试策略

项目目前主要依赖手动测试和集成测试。建议为关键功能添加单元测试，特别是：
- MCP协议处理逻辑
- 工具执行和参数验证
- 内容脚本与后台脚本的通信
- 边界情况和错误处理

可以考虑引入Jest或Vitest作为测试框架，结合Puppeteer进行端到端测试。

**Section sources**
- [background/managers/mcp_manager.js](file://background/managers/mcp_manager.js#L1-L530)
- [background/control/actions/base.js](file://background/control/actions/base.js#L1-L64)

## 调试技巧

### 开发者工具使用

Chrome开发者工具是调试扩展的主要手段：
- **Console**: 查看扩展输出的日志信息
- **Sources**: 设置断点调试JavaScript代码
- **Network**: 监控API请求和响应
- **Application**: 查看存储、缓存和Service Worker状态

### debug_regex.js调试方法

`debug_regex.js`文件用于调试正则表达式匹配，特别是处理AI生成的建议内容。使用方法如下：

```javascript
// 测试文本内容
const text = `行动建议：
短期（现在）： 深耕 B2B 定制，解决生存问题...
<suggestions>["如何针对 AI 漫剧...", "在 B2B 商业定制中..."]</suggestions>`;

// 测试正则表达式
const regex = /(?:```[\w]*\s*)?<suggestions>\s*([\s\S]*?)\s*<\/suggestions>(?:\s*```)?/i;
const suggestionsMatch = text.match(regex);

if (suggestionsMatch) {
    console.log("匹配成功！");
    console.log("捕获内容：", suggestionsMatch[1]);
} else {
    console.log("未找到匹配。");
}
```

通过修改`text`变量和正则表达式，可以快速验证匹配逻辑是否正确。

**Section sources**
- [debug_regex.js](file://debug_regex.js#L1-L30)
- [background/handlers/session/prompt/tool_executor.js](file://background/handlers/session/prompt/tool_executor.js#L1-L49)

## 功能扩展开发

### 添加新功能

要添加新功能，通常需要在相应模块中创建新文件并更新相关引用。例如，添加新的控制动作：

1. 在`background/control/actions/`目录下创建新动作文件
2. 在`background/control/actions.js`中导入并注册新动作
3. 在`background/managers/control_manager.js`的`execute`方法中添加新动作的处理逻辑

### 创建新的控制动作

控制动作通过MCP（Model Context Protocol）协议实现，允许AI直接操作浏览器。创建新动作的步骤：

1. 继承`BaseActionHandler`类
2. 实现具体动作逻辑
3. 在`BrowserActions`中添加委托方法
4. 在`ControlManager`的`execute`方法中添加动作映射

```javascript
// 示例：添加新的控制动作
class NewAction extends BaseActionHandler {
    async execute(args) {
        // 实现具体逻辑
        return result;
    }
}
```

### 集成外部服务

集成外部服务通常涉及：
1. 在`services/`目录下创建新服务文件
2. 实现API调用逻辑
3. 在适当的位置调用新服务

例如，`services/gemini_api.js`封装了与Gemini API的通信，包括认证、请求构建和响应处理。

**Section sources**
- [background/control/actions.js](file://background/control/actions.js#L1-L55)
- [background/managers/control_manager.js](file://background/managers/control_manager.js#L1-L159)
- [services/gemini_api.js](file://services/gemini_api.js#L1-L230)

## 代码提交规范与审查流程

### 代码提交规范

遵循以下提交消息格式：
```
<type>: <subject>
<BLANK LINE>
<body>
<BLANK LINE>
<footer>
```

类型包括：
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动

### 审查流程

1. 创建功能分支
2. 实现功能并编写测试
3. 提交PR，描述变更内容和影响
4. 团队成员审查代码
5. 修复审查意见
6. 合并到主分支

**Section sources**
- [README.md](file://README.md#L93-L95)

## 性能优化建议

### 减少资源加载

- 按需加载Content Scripts，避免在所有页面注入
- 压缩和优化图片资源
- 使用代码分割减少初始加载体积

### 优化通信效率

- 减少后台脚本与内容脚本之间的消息传递
- 批量处理相关操作
- 使用适当的缓存策略

### 内存管理

- 及时清理事件监听器
- 避免内存泄漏
- 监控Service Worker的内存使用

**Section sources**
- [content/index.js](file://content/index.js#L1-L190)
- [background/index.js](file://background/index.js#L1-L30)

## 安全最佳实践

### 权限最小化

- 仅请求必要的权限
- 使用`host_permissions`限制访问范围
- 避免使用`<all_urls>`除非必要

### 内容安全策略

- 严格限制`script-src`和`object-src`
- 使用沙盒环境执行第三方代码
- 避免使用`'unsafe-inline'`和`'unsafe-eval'`

### 数据保护

- 敏感数据加密存储
- 避免在日志中记录敏感信息
- 定期审查代码中的安全漏洞

**Section sources**
- [manifest.json](file://manifest.json#L89-L92)
- [background/managers/auth_manager.js](file://background/managers/auth_manager.js)

## MCP协议扩展与UI组件开发

### MCP协议支持扩展

MCP（Model Context Protocol）是本项目的核心扩展机制，允许集成外部工具和服务。扩展MCP支持的步骤：

1. 在`background/managers/mcp_manager.js`中实现服务器连接和工具发现
2. 支持SSE和HTTP两种通信模式
3. 实现工具执行和结果处理

```javascript
class MCPManager {
    async executeTool(name, args) {
        // 查找目标服务器
        // 根据服务器模式选择HTTP或SSE调用
        // 返回执行结果
    }
}
```

### UI组件开发

UI组件主要位于`sandbox/`和`sidepanel/`目录。开发新UI组件的步骤：

1. 在`sandbox/ui/`或`sidepanel/`创建新组件文件
2. 实现组件逻辑和样式
3. 在适当的位置注册和使用组件

例如，`sandbox/controllers/mcp_controller.js`实现了MCP服务器选择器，管理服务器状态和用户交互。

**Section sources**
- [background/managers/mcp_manager.js](file://background/managers/mcp_manager.js#L1-L530)
- [sandbox/controllers/mcp_controller.js](file://sandbox/controllers/mcp_controller.js#L1-L221)
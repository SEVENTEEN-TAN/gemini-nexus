# 用户操作

<cite>
**本文档引用的文件**   
- [session_manager.js](file://background/managers/session_manager.js)
- [app_controller.js](file://sandbox/controllers/app_controller.js)
- [session_flow.js](file://sandbox/controllers/session_flow.js)
- [session_manager.js](file://sandbox/core/session_manager.js)
- [sidebar.js](file://sandbox/ui/sidebar.js)
- [messaging.js](file://lib/messaging.js)
- [session.js](file://background/handlers/session.js)
</cite>

## 目录
1. [会话删除功能实现](#会话删除功能实现)
2. [会话重命名功能实现](#会话重命名功能实现)
3. [会话导出与数据管理](#会话导出与数据管理)
4. [用户交互体验实现](#用户交互体验实现)
5. [权限控制与数据一致性](#权限控制与数据一致性)

## 会话删除功能实现

会话删除功能通过多层控制器委托机制实现，确保UI实时更新和数据一致性。`handleDeleteSession`方法从AppController开始，委托至SessionFlowController执行删除逻辑。

```mermaid
sequenceDiagram
participant UI as 用户界面
participant AppController as AppController
participant SessionFlow as SessionFlowController
participant SessionManager as SessionManager
participant Storage as 存储系统
UI->>AppController : handleDeleteSession(sessionId)
AppController->>SessionFlow : handleDeleteSession(sessionId)
SessionFlow->>SessionManager : deleteSession(sessionId)
SessionManager-->>SessionFlow : 返回是否需切换会话
SessionFlow->>Storage : saveSessionsToStorage(sessions)
alt 需要切换会话
SessionFlow->>SessionFlow : switchToSession(新会话)
else 不需要切换
SessionFlow->>SessionFlow : refreshHistoryUI()
end
SessionFlow-->>AppController : 完成
AppController-->>UI : UI更新
```

**Diagram sources**
- [app_controller.js](file://sandbox/controllers/app_controller.js#L100-L102)
- [session_flow.js](file://sandbox/controllers/session_flow.js#L81-L93)
- [session_manager.js](file://sandbox/core/session_manager.js#L41-L49)

**Section sources**
- [app_controller.js](file://sandbox/controllers/app_controller.js#L100-L102)
- [session_flow.js](file://sandbox/controllers/session_flow.js#L81-L93)
- [session_manager.js](file://sandbox/core/session_manager.js#L41-L49)

## 会话重命名功能实现

会话重命名功能的实现路径从UI输入事件捕获开始，通过完整的调用链最终调用SessionManager.renameSession方法。

```mermaid
flowchart TD
A[用户点击重命名按钮] --> B[显示输入框]
B --> C[用户输入新标题]
C --> D{按下Enter或失去焦点}
D --> |确认| E[调用onRename回调]
E --> F[SessionFlowController.handleRenameSession]
F --> G[SessionManager.renameSession]
G --> H[验证标题有效性]
H --> I[更新会话标题]
I --> J[saveSessionsToStorage]
J --> K[refreshHistoryUI]
K --> L[UI更新完成]
D --> |取消| M[恢复原标题]
style A fill:#f9f,stroke:#333
style L fill:#bbf,stroke:#333
```

**Diagram sources**
- [sidebar.js](file://sandbox/ui/sidebar.js#L172-L214)
- [session_flow.js](file://sandbox/controllers/session_flow.js#L72-L78)
- [session_manager.js](file://sandbox/core/session_manager.js#L60-L67)

**Section sources**
- [sidebar.js](file://sandbox/ui/sidebar.js#L172-L214)
- [session_flow.js](file://sandbox/controllers/session_flow.js#L72-L78)
- [session_manager.js](file://sandbox/core/session_manager.js#L60-L67)

## 会话导出与数据管理

会话导出功能涉及数据序列化格式、安全考虑和错误处理机制。系统通过消息传递机制与后台通信，确保数据安全。

```mermaid
classDiagram
class SessionManager {
+sessions : Array
+currentSessionId : string
+createSession()
+deleteSession(id)
+renameSession(id, title)
+getSortedSessions()
}
class Messaging {
+sendToBackground(payload)
+saveSessionsToStorage(sessions)
+requestThemeFromStorage()
}
class SessionData {
+id : string
+title : string
+timestamp : number
+messages : Array
+context : object
}
SessionManager --> SessionData : 包含
Messaging --> SessionManager : 数据传递
SessionManager --> Messaging : saveSessionsToStorage
note right of SessionData
数据序列化格式：
- id : UUID格式
- title : 最大50字符
- timestamp : 毫秒时间戳
- messages : 消息数组
- context : Gemini上下文
end note
```

**Diagram sources**
- [session_manager.js](file://sandbox/core/session_manager.js#L5-L105)
- [messaging.js](file://lib/messaging.js#L1-L96)
- [session_manager.js](file://background/managers/session_manager.js#L6-L285)

**Section sources**
- [session_manager.js](file://sandbox/core/session_manager.js#L5-L105)
- [messaging.js](file://lib/messaging.js#L1-L96)

## 用户交互体验实现

系统实现了完整的用户交互体验，包括确认对话框、加载状态反馈和错误提示等UX细节。

```mermaid
flowchart LR
A[用户操作] --> B{操作类型}
B --> |删除会话| C[显示确认对话框]
B --> |重命名会话| D[显示编辑输入框]
B --> |创建会话| E[显示加载状态]
C --> F[用户确认]
F --> G[执行删除]
F --> H[取消操作]
D --> I[输入验证]
I --> J[长度限制50字符]
J --> K[保存更改]
E --> L[UI状态更新]
L --> M[成功/失败反馈]
style C fill:#ffcccc,stroke:#f66
style D fill:#ccccff,stroke:#66f
style E fill:#ccffcc,stroke:#6f6
```

**Diagram sources**
- [sidebar.js](file://sandbox/ui/sidebar.js#L231-L233)
- [session_flow.js](file://sandbox/controllers/session_flow.js#L14-L22)
- [app_controller.js](file://sandbox/controllers/app_controller.js#L77-L79)

**Section sources**
- [sidebar.js](file://sandbox/ui/sidebar.js#L231-L233)
- [session_flow.js](file://sandbox/controllers/session_flow.js#L14-L22)

## 权限控制与数据一致性

系统通过多层次的权限控制和数据一致性保障措施，确保用户操作的安全性和可靠性。

```mermaid
graph TB
A[前端UI] --> |权限检查| B[AppController]
B --> |委托| C[SessionFlowController]
C --> |操作| D[SessionManager]
D --> |数据验证| E[业务逻辑]
E --> |持久化| F[存储系统]
F --> |确认| G[UI更新]
subgraph "权限控制"
H[会话所有权验证]
I[操作权限检查]
J[数据完整性验证]
end
subgraph "数据一致性"
K[事务性操作]
L[原子更新]
M[错误回滚]
end
E --> H
E --> I
E --> J
D --> K
D --> L
D --> M
style H fill:#f96,stroke:#f63
style I fill:#f96,stroke:#f63
style J fill:#f96,stroke:#f63
style K fill:#69f,stroke:#36c
style L fill:#69f,stroke:#36c
style M fill:#69f,stroke:#36c
```

**Diagram sources**
- [app_controller.js](file://sandbox/controllers/app_controller.js#L11-L36)
- [session_flow.js](file://sandbox/controllers/session_flow.js#L7-L12)
- [session_manager.js](file://sandbox/core/session_manager.js#L6-L9)

**Section sources**
- [app_controller.js](file://sandbox/controllers/app_controller.js#L11-L36)
- [session_flow.js](file://sandbox/controllers/session_flow.js#L7-L12)
- [session_manager.js](file://sandbox/core/session_manager.js#L6-L9)
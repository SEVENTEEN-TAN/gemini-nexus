# é”™è¯¯å¤„ç†æµ

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**   
- [messages.js](file://background/messages.js)
- [log_manager.js](file://background/managers/log_manager.js)
- [session_manager.js](file://background/managers/session_manager.js)
- [mcp_manager.js](file://background/managers/mcp_manager.js)
- [logger.js](file://lib/logger.js)
- [gemini_api.js](file://services/gemini_api.js)
- [message_handler.js](file://sandbox/controllers/message_handler.js)
- [message.js](file://sandbox/render/message.js)
- [keep_alive.js](file://background/managers/keep_alive.js)
- [connection.js](file://background/control/connection.js)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é”™è¯¯æ—¥å¿—çš„æ•è·ä¸æŒä¹…åŒ–](#é”™è¯¯æ—¥å¿—çš„æ•è·ä¸æŒä¹…åŒ–)
3. [APIä¸MCPè°ƒç”¨çš„é”™è¯¯å¤„ç†](#apiä¸mcpè°ƒç”¨çš„é”™è¯¯å¤„ç†)
4. [UIå±‚çš„é”™è¯¯å±•ç¤º](#uiå±‚çš„é”™è¯¯å±•ç¤º)
5. [é‡è¯•é€»è¾‘ä¸é™çº§ç­–ç•¥](#é‡è¯•é€»è¾‘ä¸é™çº§ç­–ç•¥)
6. [é”™è¯¯å¤„ç†æµç¨‹å›¾](#é”™è¯¯å¤„ç†æµç¨‹å›¾)

## ç®€ä»‹
Gemini Nexus çš„é”™è¯¯å¤„ç†æœºåˆ¶æ˜¯ä¸€ä¸ªè´¯ç©¿æ•´ä¸ªåº”ç”¨æ ˆçš„ç³»ç»ŸåŒ–æµç¨‹ï¼Œä»åº•å±‚çš„ç½‘ç»œè¯·æ±‚ã€APIè°ƒç”¨ï¼Œåˆ°ä¸Šå±‚çš„UIå±•ç¤ºï¼Œéƒ½æœ‰ä¸€å¥—å®Œæ•´çš„å¼‚å¸¸æ•è·ã€ä¼ é€’ä¸å¤„ç†ç­–ç•¥ã€‚è¯¥æœºåˆ¶ç¡®ä¿äº†å½“ç³»ç»Ÿå‡ºç°æ•…éšœæ—¶ï¼Œç”¨æˆ·èƒ½å¤Ÿè·å¾—æ¸…æ™°ã€å‹å¥½çš„é”™è¯¯æç¤ºï¼ŒåŒæ—¶å¼€å‘è€…ä¹Ÿèƒ½é€šè¿‡æ—¥å¿—ç³»ç»Ÿè¿›è¡Œæœ‰æ•ˆçš„è°ƒè¯•å’Œé—®é¢˜è¿½è¸ªã€‚æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ `LogManager` ç”¨äºæ—¥å¿—çš„é›†ä¸­å­˜å‚¨ï¼Œ`SessionManager` å’Œ `MCPManager` è´Ÿè´£ä¸šåŠ¡é€»è¾‘ä¸­çš„é”™è¯¯æ„é€ ä¸å“åº”ï¼Œä»¥åŠ `sandbox` å±‚çš„ `MessageHandler` è¿›è¡Œæœ€ç»ˆçš„é”™è¯¯æ¸²æŸ“ã€‚

## é”™è¯¯æ—¥å¿—çš„æ•è·ä¸æŒä¹…åŒ–

åœ¨ Gemini Nexus ä¸­ï¼Œæ‰€æœ‰ç»„ä»¶çš„é”™è¯¯æ—¥å¿—éƒ½é€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„ä¸­å¤®æ—¥å¿—ç³»ç»Ÿè¿›è¡Œç®¡ç†ã€‚è¯¥ç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯ `background/messages.js` æ–‡ä»¶ä¸­å®šä¹‰çš„å…¨å±€æ¶ˆæ¯ç›‘å¬å™¨ã€‚

### æ—¥å¿—æ¥æ”¶æœºåˆ¶
ä»»ä½•ç»„ä»¶éƒ½å¯ä»¥é€šè¿‡å‘é€ä¸€ä¸ªç±»å‹ä¸º `LOG_ENTRY` çš„æ¶ˆæ¯æ¥è®°å½•æ—¥å¿—ã€‚æ¶ˆæ¯ç›‘å¬å™¨ä¼šæ£€æŸ¥è¯·æ±‚çš„ `action` å­—æ®µï¼Œä¸€æ—¦åŒ¹é…åˆ° `LOG_ENTRY`ï¼Œå°±ä¼šè°ƒç”¨ `LogManager` çš„ `add` æ–¹æ³•ï¼Œå°†æ—¥å¿—æ¡ç›®æ·»åŠ åˆ°å†…å­˜ä¸­ï¼Œå¹¶å¼‚æ­¥æŒä¹…åŒ–åˆ° `chrome.storage.local`ã€‚

```mermaid
flowchart TD
A[ä»»æ„ç»„ä»¶] --> |å‘é€ LOG_ENTRY æ¶ˆæ¯| B[background/messages.js]
B --> |è°ƒç”¨ logManager.add()| C[LogManager]
C --> |å°†æ—¥å¿—å­˜å…¥å†…å­˜æ•°ç»„| D[å†…å­˜æ—¥å¿—ç¼“å†²åŒº]
C --> |å¼‚æ­¥ä¿å­˜åˆ°| E[chrome.storage.local]
```

**Diagram sources**
- [messages.js](file://background/messages.js#L25-L27)
- [log_manager.js](file://background/managers/log_manager.js#L29-L40)

### æ—¥å¿—ç®¡ç†å™¨ (LogManager)
`LogManager` ç±»è´Ÿè´£æ—¥å¿—çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚å®ƒåœ¨æ„é€ æ—¶åˆå§‹åŒ–ä¸€ä¸ªå†…å­˜æ•°ç»„ `logs`ï¼Œå¹¶ä» `chrome.storage.local` åŠ è½½å†å²æ—¥å¿—ã€‚ä¸ºäº†é˜²æ­¢å†…å­˜æº¢å‡ºï¼Œå®ƒè®¾ç½®äº† `MAX_LOGS` é™åˆ¶ï¼ˆé»˜è®¤2000æ¡ï¼‰ï¼Œå½“æ—¥å¿—æ•°é‡è¶…è¿‡æ­¤é™åˆ¶æ—¶ï¼Œä¼šè‡ªåŠ¨è£å‰ªæœ€æ—§çš„æ—¥å¿—ã€‚æ¯æ¬¡æ·»åŠ æ–°æ—¥å¿—åï¼Œéƒ½ä¼šè§¦å‘ `_save` æ–¹æ³•ï¼Œå°†æ•´ä¸ªæ—¥å¿—æ•°ç»„ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ã€‚

**Section sources**
- [log_manager.js](file://background/managers/log_manager.js#L4-L62)

## APIä¸MCPè°ƒç”¨çš„é”™è¯¯å¤„ç†

å½“ä¸å¤–éƒ¨æœåŠ¡ï¼ˆå¦‚ Gemini API æˆ– MCP æœåŠ¡å™¨ï¼‰äº¤äº’æ—¶ï¼Œç³»ç»Ÿä¼šæ•è·å„ç§é”™è¯¯ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºç»“æ„åŒ–çš„å“åº”å¯¹è±¡è¿”å›ç»™è°ƒç”¨æ–¹ã€‚

### SessionManager çš„é”™è¯¯å¤„ç†
`SessionManager` æ˜¯å¤„ç†ä¸ Gemini API é€šä¿¡çš„æ ¸å¿ƒã€‚åœ¨ `handleSendPrompt` æ–¹æ³•ä¸­ï¼Œå®ƒé€šè¿‡ `sendGeminiMessage` å‘é€è¯·æ±‚ã€‚å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œä¼šæ•è·é”™è¯¯å¹¶è¿›è¡Œåˆ†ç±»å¤„ç†ã€‚

- **è®¤è¯å¤±æ•ˆ (401/403)**ï¼šå½“æ£€æµ‹åˆ°ä¼šè¯è¿‡æœŸæˆ–æœªç™»å½•æ—¶ï¼Œç³»ç»Ÿä¼šå°è¯•é€šè¿‡ `AuthManager` åˆ‡æ¢åˆ°å¤‡ç”¨è´¦å·è¿›è¡Œé‡è¯•ã€‚å¦‚æœæ‰€æœ‰è´¦å·éƒ½å¤±è´¥ï¼Œåˆ™æ„é€ ä¸€ä¸ªåŒ…å«ç™»å½•é“¾æ¥çš„å‹å¥½é”™è¯¯æ¶ˆæ¯ã€‚
- **é€Ÿç‡é™åˆ¶ (Rate Limited)**ï¼šå½“è¯·æ±‚è¿‡äºé¢‘ç¹æ—¶ï¼Œä¼šè¿”å›ä¸€ä¸ªæç¤ºç”¨æˆ·ç¨åå†è¯•çš„é”™è¯¯ã€‚
- **ç©ºå“åº”æˆ–è§£æå¤±è´¥**ï¼šå½“æœåŠ¡å™¨æ— å“åº”æˆ–è¿”å›çš„æ•°æ®æ— æ³•è§£ææ—¶ï¼Œä¼šæç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢ã€‚

é”™è¯¯æœ€ç»ˆè¢«å°è£…æˆä¸€ä¸ªåŒ…å« `action: "GEMINI_REPLY"` å’Œ `status: "error"` çš„å“åº”å¯¹è±¡ï¼Œå¹¶é€šè¿‡ `sendResponse` è¿”å›ã€‚

```mermaid
sequenceDiagram
participant UI as UIå±‚
participant SM as SessionManager
participant GA as Gemini API
participant AM as AuthManager
UI->>SM : å‘é€è¯·æ±‚ (SEND_PROMPT)
SM->>GA : è°ƒç”¨ sendGeminiMessage
GA--x SM : è¿”å› 401 é”™è¯¯
SM->>AM : æ£€æµ‹åˆ°è®¤è¯é”™è¯¯ï¼Œå°è¯•åˆ‡æ¢è´¦å·
AM-->>SM : è¿”å›æ–°è´¦å·ä¸Šä¸‹æ–‡
SM->>GA : ä½¿ç”¨æ–°è´¦å·é‡è¯•
GA-->>SM : æˆåŠŸå“åº”
SM->>UI : è¿”å›æˆåŠŸç»“æœ (GEMINI_REPLY, status : success)
```

**Diagram sources**
- [session_manager.js](file://background/managers/session_manager.js#L129-L198)
- [gemini_api.js](file://services/gemini_api.js#L154-L218)

### MCPManager çš„é”™è¯¯å¤„ç†
`MCPManager` è´Ÿè´£ä¸ MCPï¼ˆModel Context Protocolï¼‰æœåŠ¡å™¨çš„è¿æ¥å’Œé€šä¿¡ã€‚åœ¨ `connectServer` å’Œ `sendRequestHttp` ç­‰æ–¹æ³•ä¸­ï¼ŒåŒ…å«äº†å¯¹è¿æ¥å¤±è´¥ã€HTTPé”™è¯¯å’ŒJSON-RPCé”™è¯¯çš„å¤„ç†ã€‚

ä¾‹å¦‚ï¼Œåœ¨ `sendRequestHttp` æ–¹æ³•ä¸­ï¼Œå¦‚æœ `fetch` è¯·æ±‚å¤±è´¥æˆ–è¿”å›é200çŠ¶æ€ç ï¼Œä¼šç›´æ¥æŠ›å‡ºé”™è¯¯ã€‚å¦‚æœæœåŠ¡å™¨è¿”å›çš„JSON-RPCå“åº”ä¸­åŒ…å« `error` å­—æ®µï¼Œä¹Ÿä¼šå°†å…¶è½¬æ¢ä¸ºJavaScripté”™è¯¯æŠ›å‡ºã€‚è¿™äº›é”™è¯¯æœ€ç»ˆä¼šä¼ é€’åˆ° `SessionManager`ï¼Œå¹¶è¢«ç»Ÿä¸€å¤„ç†ã€‚

**Section sources**
- [mcp_manager.js](file://background/managers/mcp_manager.js#L229-L258)

## UIå±‚çš„é”™è¯¯å±•ç¤º

`sandbox` å±‚è´Ÿè´£å°†åå°è¿”å›çš„é”™è¯¯å“åº”è§£æå¹¶ä»¥ç”¨æˆ·å‹å¥½çš„æ–¹å¼å±•ç¤ºåœ¨ç•Œé¢ä¸Šã€‚

### MessageHandler çš„é”™è¯¯å¤„ç†
`MessageHandler` ç±»çš„ `handle` æ–¹æ³•æ˜¯å¤„ç†æ‰€æœ‰åå°æ¶ˆæ¯çš„å…¥å£ã€‚å½“æ”¶åˆ° `action: "GEMINI_REPLY"` ä¸” `status: "error"` çš„æ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šè°ƒç”¨ `handleGeminiReply` æ–¹æ³•ã€‚

è¯¥æ–¹æ³•ä¼šæ£€æŸ¥å“åº”ä¸­çš„ `text` å­—æ®µï¼Œå…¶ä¸­åŒ…å«äº†ç»è¿‡ `SessionManager` æ ¼å¼åŒ–åçš„HTMLé”™è¯¯æ¶ˆæ¯ï¼ˆä¾‹å¦‚åŒ…å«é“¾æ¥çš„ç™»å½•æç¤ºï¼‰ã€‚ç„¶åï¼Œå®ƒä¼šåˆ›å»ºæˆ–æ›´æ–°ä¸€ä¸ªAIæ¶ˆæ¯æ°”æ³¡ï¼Œå°†é”™è¯¯å†…å®¹æ¸²æŸ“è¿›å»ã€‚ç”±äºé”™è¯¯æ¶ˆæ¯ä¸­å¯èƒ½åŒ…å«HTMLé“¾æ¥ï¼ŒUIå±‚ä¼šæ­£ç¡®åœ°è§£æå¹¶ä½¿å…¶å¯ç‚¹å‡»ï¼Œå¼•å¯¼ç”¨æˆ·å®Œæˆç™»å½•ç­‰æ“ä½œã€‚

```mermaid
flowchart TD
A[background] --> |GEMINI_REPLY (error)| B[sandbox]
B --> C[MessageHandler.handle]
C --> D{status == error?}
D --> |æ˜¯| E[handleGeminiReply]
E --> F[åˆ›å»º/æ›´æ–°æ¶ˆæ¯æ°”æ³¡]
F --> G[æ¸²æŸ“é”™è¯¯æ–‡æœ¬ (å«HTML)]
G --> H[æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢]
```

**Diagram sources**
- [message_handler.js](file://sandbox/controllers/message_handler.js#L25-L281)
- [message.js](file://sandbox/render/message.js#L266-L323)

### é”™è¯¯æ¶ˆæ¯çš„æ¸²æŸ“
`appendMessage` å‡½æ•°è´Ÿè´£åˆ›å»ºæ¶ˆæ¯UIã€‚å¯¹äºé”™è¯¯æ¶ˆæ¯ï¼Œå®ƒä¼šå°† `request.text` ä¸­çš„å†…å®¹ï¼ˆå¦‚ `Error: ğŸ”‘ è´¦å· (Index: 0) æœªç™»å½•...`ï¼‰ç›´æ¥ä¼ é€’ç»™ `renderContent` å‡½æ•°è¿›è¡Œæ¸²æŸ“ã€‚`renderContent` ä¼šå¤„ç†å…¶ä¸­çš„HTMLæ ‡ç­¾ï¼Œç¡®ä¿é“¾æ¥ç­‰å…ƒç´ æ­£å¸¸æ˜¾ç¤ºã€‚

**Section sources**
- [message_handler.js](file://sandbox/controllers/message_handler.js#L251-L278)
- [message.js](file://sandbox/render/message.js#L143-L147)

## é‡è¯•é€»è¾‘ä¸é™çº§ç­–ç•¥

ç³»ç»Ÿåœ¨é¢å¯¹ä¸´æ—¶æ€§æ•…éšœæ—¶ï¼Œå…·å¤‡è‡ªåŠ¨é‡è¯•å’Œé™çº§çš„èƒ½åŠ›ï¼Œä»¥æé«˜æ•´ä½“çš„å¥å£®æ€§ã€‚

### è®¤è¯å¤±æ•ˆçš„é‡è¯•
å½“ `SessionManager` é¦–æ¬¡è°ƒç”¨ `sendGeminiMessage` å¤±è´¥ä¸”åŸå› ä¸ºè®¤è¯é”™è¯¯æ—¶ï¼Œå®ƒä¼šè¿›å…¥ä¸€ä¸ªé‡è¯•å¾ªç¯ã€‚é€šè¿‡ `AuthManager.rotateAccount()` æ–¹æ³•ï¼Œç³»ç»Ÿä¼šå°è¯•ä½¿ç”¨é…ç½®ä¸­çš„ä¸‹ä¸€ä¸ªè´¦å·è¿›è¡Œè¯·æ±‚ã€‚è¿™å®ç°äº†è´¦å·é—´çš„è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»ã€‚

### Keep-Alive æœºåˆ¶
`keep_alive.js` ä¸­çš„ `KeepAliveManager` ä¼šå®šæœŸå‘ä¸€ä¸ªç‰¹å®šçš„Googleç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œä»¥â€œæ—‹è½¬â€ä¼šè¯Cookieï¼Œé˜²æ­¢å…¶è¿‡æœŸã€‚å¦‚æœæ­¤è¯·æ±‚å¤±è´¥ï¼Œ`_handleError` æ–¹æ³•ä¼šæ ¹æ®HTTPçŠ¶æ€ç è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚ï¼Œæ”¶åˆ°401æˆ–403æ—¶ï¼Œä¼šæ¸…é™¤æœ¬åœ°çš„ `geminiContext`ï¼Œå¼ºåˆ¶ç”¨æˆ·åœ¨ä¸‹æ¬¡æ“ä½œæ—¶é‡æ–°ç™»å½•ï¼Œè¿™æ˜¯ä¸€ç§ä¼˜é›…çš„é™çº§ç­–ç•¥ã€‚

### ç½‘ç»œä¸­æ–­çš„å¤„ç†
åœ¨ `connection.js` ä¸­ï¼Œ`BrowserConnection` ç±»åœ¨ `attach` æ–¹æ³•ä¸­å¤„ç†è°ƒè¯•å™¨è¿æ¥ã€‚å¦‚æœ `chrome.debugger.attach` å¤±è´¥ï¼ˆä¾‹å¦‚åœ¨å—é™é¡µé¢ä¸Šï¼‰ï¼Œå®ƒä¼šè®°å½•è­¦å‘Šä½†ä¸ä¼šä¸­æ–­ä¸»æµç¨‹ï¼Œå…è®¸å…¶ä»–éè°ƒè¯•åŠŸèƒ½ï¼ˆå¦‚å¯¼èˆªï¼‰ç»§ç»­æ‰§è¡Œï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§é™çº§ç­–ç•¥ã€‚

**Section sources**
- [session_manager.js](file://background/managers/session_manager.js#L138-L143)
- [keep_alive.js](file://background/managers/keep_alive.js#L82-L93)
- [connection.js](file://background/control/connection.js#L74-L78)

## é”™è¯¯å¤„ç†æµç¨‹å›¾

ä»¥ä¸‹æµç¨‹å›¾æ€»ç»“äº†ä»é”™è¯¯å‘ç”Ÿåˆ°æœ€ç»ˆå±•ç¤ºçš„å®Œæ•´è·¯å¾„ã€‚

```mermaid
flowchart TD
subgraph "åå° (Background)"
A[APIè°ƒç”¨å¤±è´¥] --> B[SessionManager æ•è·é”™è¯¯]
B --> C[æ„é€ é”™è¯¯å“åº”å¯¹è±¡]
C --> D[é€šè¿‡ sendResponse è¿”å›]
E[MCPè¿æ¥å¼‚å¸¸] --> F[MCPManager æŠ›å‡ºé”™è¯¯]
F --> B
end
subgraph "é€šä¿¡å±‚"
D --> G[æ¶ˆæ¯ä¼ é€’åˆ° sandbox]
G --> H[MessageHandler.handle]
end
subgraph "æ²™ç®± (Sandbox)"
H --> I{action == GEMINI_REPLY?}
I --> |æ˜¯| J{status == error?}
J --> |æ˜¯| K[handleGeminiReply]
K --> L[è°ƒç”¨ appendMessage]
L --> M[æ¸²æŸ“é”™è¯¯æ¶ˆæ¯]
M --> N[æ˜¾ç¤ºåœ¨UI]
end
subgraph "æ—¥å¿—ç³»ç»Ÿ"
O[ä»»æ„ç»„ä»¶] --> |LOG_ENTRY| P[LogManager]
P --> Q[å†…å­˜å­˜å‚¨]
Q --> R[æŒä¹…åŒ–åˆ° chrome.storage]
end
```

**Diagram sources**
- [session_manager.js](file://background/managers/session_manager.js#L129-L198)
- [messages.js](file://background/messages.js#L22-L79)
- [message_handler.js](file://sandbox/controllers/message_handler.js#L17-L28)
- [log_manager.js](file://background/managers/log_manager.js#L29-L40)